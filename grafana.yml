---

- hosts: homelab

  vars:
    application: grafana

    docker_network: "{{ networks.user }}"

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "472"  # grafana user
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create directories
      ansible.builtin.file:
        path: "{{ config_directory }}/{{ item }}"
        state: directory
        owner: "472"  # grafana user
        group: "{{ common_group }}"
        mode: "0771"
      loop:
        - "provisioning"
        - "provisioning/datasources"
        - "provisioning/dashboards"
        - "data"
        - "data/plugins"

    - name: Download plugins
      ansible.builtin.unarchive:
        src: "https://grafana.com/api/plugins/{{ item.name }}/versions/{{ item.version }}/download"
        dest: "{{ config_directory }}/data/plugins"
        remote_src: true
      loop:
        - name: grafana-piechart-panel
          version: 1.6.2
      notify: Restart

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: grafana/grafana:10.1.1
        volumes:
          - "{{ config_directory }}/data:/var/lib/grafana"
          - "{{ config_directory }}/provisioning:/etc/grafana/provisioning"
        traefik:
          - port: 3000
        homepage:
          name: Grafana
          group: Monitoring
          weight: 100
          description: "Dashboards"
          widget:
            url: "https://{{ application }}.{{ common_tld }}"
            username: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              61373333346334636532653337323135333961643536313433653363353762333465313736376662
              3466373830343936316232316664666331636336366462630a656130613266646163316261626463
              39363536306639333663643937326230343862303338376535373538363466613732653232386532
              3833626361323864650a316565613137336633393032626634393234616666613635373464366438
              3932
            password: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              35373162613364373165646264323930323362313136313638656365636563383864306636613232
              6233343762653465643537653863663235613539373530320a333733393362623961663239666664
              30353935373838323331303633633037633061653036363066663265383932616562333065323665
              6230306363376636370a636435386363343132636537653839663365373037633738313130343035
              39333638383636306362643362663436326462343765396533313335393335396561333663663735
              6639373264373637353636393431666636633666656235323565
            fields: '["dashboards", "datasources"]'
        blackbox:
          path: /api/health
