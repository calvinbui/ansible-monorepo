---

- hosts: homelab

  vars:
    application: ntfy

    # Must be exactly 22 chars for bcrypt
    ntfy_salt: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      62633866643438366131306639313261373266393863663435633564643630306138613131653835
      3636306633323930633233646565303839653833643435390a643761333634356561303838373430
      39323838646238613936643838393163356332333033306331356339633631393338363035626661
      6266633436353066370a393437383137666263383633643130356335383565323466326536313031
      34353131636631306534373362396230626363336132353065383564666361323538

    ntfy_users:
      -
        username: "{{ common_user }}"
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          35623131356135323139343562366462373839373133346335616362363431623664396634356563
          3636373534386365666461373162633161343961333965360a616335343665636137373032643137
          32663364363461633066313030393362363361636662376466383564306439666630366163313938
          3834366238313233640a393931383537663531323230383337303263393264616463376132363162
          65356237396534376361636664366131313835303535366462346437316134353134
        role: admin

    ntfy_acls:
      -
        # UnifiedPush notifications
        username: "*"
        topic: "up*"
        permission: "write-only"

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"
      loop:
        - "{{ config_directory }}/config"
        - "{{ config_directory }}/cache"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: binwiederhier/ntfy:v2.14.0
        command:
          - serve
        user: "{{ common_user_id }}:{{ common_group_id }}"
        env:
          TZ: "{{ common_timezone }}"

          NTFY_BASE_URL: "https://{{ application }}.{{ common_tld }}"

          NTFY_ATTACHMENT_CACHE_DIR: /var/cache/ntfy/attachments
          NTFY_CACHE_FILE: "/var/cache/ntfy/cache.db"
          NTFY_CACHE_DURATION: "72h"

          NTFY_AUTH_FILE: "/var/lib/ntfy/user.db"
          NTFY_AUTH_DEFAULT_ACCESS: deny-all

          NTFY_AUTH_USERS: >-
            {%- for user in ntfy_users -%}
            {{ user.username }}:{{ user.password | string | ansible.builtin.password_hash('bcrypt', salt=(ntfy_salt | string)) }}:{{ user.role }}
            {%- if not loop.last -%},{%- endif -%}
            {%- endfor -%}

          NTFY_AUTH_ACCESS: >-
            {%- for user in ntfy_acls -%}
            {{ user.username }}:{{ user.topic }}:{{ user.permission }}
            {%- if not loop.last -%},{%- endif -%}
            {%- endfor -%}

          NTFY_BEHIND_PROXY: "true"

          NTFY_ENABLE_SIGNUP: "false"

          NTFY_WEB_ROOT: disable
        volumes:
          - "{{ config_directory }}/config:/var/lib/ntfy"
          - "{{ config_directory }}/cache:/var/cache/ntfy"
          - "{{ config_directory }}/attachments:/var/cache/ntfy/attachments"
        traefik:
          - port: 80
        blackbox:
          path: /v1/health
