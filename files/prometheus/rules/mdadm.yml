---

groups:
  - name: MDADM
    rules:
      -
        alert: MDArrayDegraded
        expr: node_md_disks{state="active"} < node_md_disks_required
        for: 5m
        annotations:
          summary: MDADM Array Degraded
          description: "{{ $labels.device }} has {{ $value }} active disks but requires {{ query \"node_md_disks_required{device='\" $labels.device \"'}\" | first | value }} - array is degraded"
      -
        alert: MDArrayDiskFailed
        expr: node_md_disks{state="failed"} > 0
        for: 1m
        annotations:
          summary: MDADM Disk Failed
          description: "{{ $labels.device }} has {{ $value }} failed disk(s)"
      -
        alert: MDArrayInactive
        expr: node_md_state{state="inactive"} == 1
        for: 1m
        annotations:
          summary: MDADM Array Inactive
          description: "{{ $labels.device }} is inactive - array not available"
      -
        alert: MDArrayResyncing
        expr: node_md_state{state="resync"} == 1
        for: 5m
        annotations:
          summary: MDADM Array Resyncing
          description: "{{ $labels.device }} is resyncing ({{ query \"node_md_blocks_synced{device='\" $labels.device \"'}\" | first | value | humanize }} of {{ query \"node_md_blocks{device='\" $labels.device \"'}\" | first | value | humanize }} blocks synced)"
      -
        alert: MDArrayRecovering
        expr: node_md_state{state="recovering"} == 1
        for: 1m
        annotations:
          summary: MDADM Array Recovering
          description: "{{ $labels.device }} is recovering from disk failure"
      -
        alert: MDArrayNotFullySynced
        expr: node_md_blocks_synced < node_md_blocks
        for: 1h
        annotations:
          summary: MDADM Array Not Fully Synced
          description: "{{ $labels.device }} sync incomplete for over 1 hour ({{ query \"node_md_blocks_synced{device='\" $labels.device \"'}\" | first | value | humanize }} of {{ query \"node_md_blocks{device='\" $labels.device \"'}\" | first | value | humanize }} blocks)"
