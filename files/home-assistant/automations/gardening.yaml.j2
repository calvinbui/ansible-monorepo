#jinja2: lstrip_blocks: True, trim_blocks: False
---
{% for g in home_assistant_gardening.systems %}
- id: gardening_{{ g.name | ansible.builtin.lower | ansible.builtin.replace(" ", "_") }}
  alias: Gardening - {{ g.name }}
  description: ""
  triggers:
    - platform: time
      at: "{{ g.time | ansible.builtin.string }}"
  conditions:
    - condition: numeric_state
      entity_id: sensor.smart_irrigation_{{ g.name | ansible.builtin.lower | ansible.builtin.replace(" ", "_") }}
      above: 0
    - condition: not
      conditions:
        - condition: state
          entity_id: sensor.meteorological_season
          state: winter
      alias: Not Winter
    - alias: Season / Day of Week
      condition: or
      conditions:
      {% for k, v in home_assistant_gardening.schedule.items() %}
        - alias: {{ k | ansible.builtin.title }}
          condition: and
          conditions:
            - condition: state
              entity_id: sensor.meteorological_season
              state: {{ k }}
            - condition: time
              weekday:
              {% for s in v %}
                - {{ s[:3] | ansible.builtin.lower }}
              {% endfor %}
      {% endfor %}
  actions:
    - action: linktap.start_watering
      target:
        entity_id: valve.linktap_{{ g.linktap }}
      data:
        seconds: "{% raw %}{{ states(\"sensor.smart_irrigation_{% endraw %}{{ g.name | ansible.builtin.lower | ansible.builtin.replace(" ", "_") }}{% raw %}\") }}{% endraw %}"
    - action: smart_irrigation.reset_bucket
      metadata: {}
      data: {}
      target:
        entity_id: sensor.smart_irrigation_{{ g.name | ansible.builtin.lower | ansible.builtin.replace(" ", "_") }}
  mode: single
{% endfor %}
