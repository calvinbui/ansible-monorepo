---

- hosts: homeserver

  vars:
    application: opnsense-backup

    container_network: "{{ networks.mgmt }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_root_group }}"
        mode: "0771"

    - name: Create backup folder
      ansible.builtin.file:
        path: "{{ common_directory_backup }}/opnsense"
        state: directory
        owner: "{{ common_user_id }}"
        group: "{{ common_group_id }}"
        mode: "0771"

    - name: Generate ED25519 SSH key pair
      community.crypto.openssh_keypair:
        path: "{{ config_directory }}/id_ed25519"
        type: ed25519
        state: present
      register: _opnsense_backup_ed25519_key

    - name: Generate ED25519 SSH key pair
      community.crypto.openssh_keypair:
        path: "{{ config_directory }}/id_ed25519"
        type: ed25519
        state: present
      register: _opnsense_backup_ed25519_key

    - name: Generate RSA SSH key pair
      community.crypto.openssh_keypair:
        path: "{{ config_directory }}/id_rsa"
        type: rsa
        size: 4096
        state: present
      register: _opnsense_backup_rsa_key

    - name: Create container
      ansible.builtin.include_role:
        name: podman_container
      vars:
        image: ghcr.io/atmoz/sftp/debian:latest
        user: root
        command:
          - "opnsense::{{ common_user_id }}"
        volumes:
          - "{{ _opnsense_backup_ed25519_key.filename }}:/etc/ssh/ssh_host_ed25519_key"
          - "{{ _opnsense_backup_ed25519_key.filename }}.pub:/home/opnsense/.ssh/keys/{{ _opnsense_backup_ed25519_key.filename | ansible.builtin.basename }}.pub"

          - "{{ _opnsense_backup_rsa_key.filename }}:/etc/ssh/ssh_host_rsa_key"
          - "{{ _opnsense_backup_rsa_key.filename }}.pub:/home/opnsense/.ssh/keys/{{ _opnsense_backup_rsa_key.filename | ansible.builtin.basename }}.pub"

          - "{{ common_directory_backup }}/opnsense:/home/opnsense/share"
