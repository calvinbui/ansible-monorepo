---

- hosts: homelab:octopi

  vars:
    application: acme.sh

    cert_cloudflare_email: "{{ cloudflare_email }}"
    cert_cloudflare_api_token: "{{ cloudflare_api }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0700"
      register: _config_dir

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    # https://github.com/Neilpang/acme.sh/wiki/How-to-install
    - name: Install socat
      ansible.builtin.apt:
        name: socat
        state: present

    - name: Download Neilpang's acme.sh
      ansible.builtin.git:
        repo: https://github.com/acmesh-official/acme.sh.git
        dest: "{{ _config_dir.path }}/repo"
        version: 3.0.4

    - name: Setup acme.sh
      ansible.builtin.shell: |
        ./acme.sh --install \
        --home "{{ _config_dir.path }}/install" \
        --config-home "{{ _config_dir.path }}/config" \
        --cert-home "{{ _config_dir.path }}/certs" \
        --accountemail "{{ common_email_username }}" \
        --log "{{ _config_dir.path }}/{{ application }}.log"
      args:
        chdir: "{{ _config_dir.path }}/repo"
        executable: "/bin/bash"
      changed_when: false

    - name: Create scripts directories
      ansible.builtin.file:
        path: "{{ _config_dir.path }}/scripts"
        state: directory
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0775"

    - name: Copy scripts
      ansible.builtin.template:
        src: "{{ files_directory }}/{{ item.script }}"
        dest: "{{ _config_dir.path }}/scripts/{{ item.script }}"
        mode: "0755"
      loop: "{{ cert_domains }}"

    - name: Setup Cloudflare creds
      ansible.builtin.lineinfile:
        path: "{{ _config_dir.path }}/config/account.conf"
        regex: "{{ item.regex }}"
        line: "{{ item.line }}"
      loop:
        - regex: "^SAVED_CF_Key"
          line: "SAVED_CF_Key='{{ cert_cloudflare_api_token }}'"
        - regex: "^SAVED_CF_Email"
          line: "SAVED_CF_Email='{{ cert_cloudflare_email }}'"

    - name: Generate certs for each domain
      ansible.builtin.shell: /bin/bash -ic ". acme.sh.env && acme.sh --issue {{ item.method }} --domain {{ item.domain }} --post-hook '{{ _config_dir.path }}/scripts/{{ item.script }} {{ item.script_args }}'"
      args:
        chdir: "{{ _config_dir.path }}/install"
        executable: /bin/bash
      register: result
      loop: "{{ cert_domains }}"
      failed_when: result.rc == 1 or result.rc == 127
      changed_when: result.rc == 0
