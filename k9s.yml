- hosts: homelab
  become: true
  vars:
    k9s_version: v0.24.7
  tasks:
    - name: Get current version
      command: /usr/local/bin/k9s version --short
      args:
        warn: false
      changed_when: false
      check_mode: false
      register: __k9s_version_output

    - when: __k9s_version_output.stdout_lines[0].split(" ")[-1] != k9s_version
      block:
        - name: Get checksum list
          set_fact:
            __k9s_checksums: "{{ lookup('url', 'https://github.com/derailed/k9s/releases/download/' + k9s_version + '/checksums.txt', wantlist=True) | list }}"
          run_once: true

        - name: Get checksum for x86_64 architecture
          set_fact:
            __k9s_checksum: "{{ item.split(' ')[0] }}"
          with_items: "{{ __k9s_checksums }}"
          when:
            - "('Linux_x86_64.tar.gz') in item"

        - name: Download k9s
          get_url:
            url: "https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/k9s_Linux_x86_64.tar.gz"
            dest: /tmp/k9s_Linux_x86_64.tar.gz
            checksum: "sha256:{{ __k9s_checksum }}"

        - name: Install k9s
          unarchive:
            src: /tmp/k9s_Linux_x86_64.tar.gz
            dest: /usr/local/bin/
            remote_src: true
            extra_opts:
              - k9s
