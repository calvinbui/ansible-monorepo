- hosts: homelab
  become: true
  vars:
    k9s_version: v0.24.7
    k9s_dir: /usr/local/bin
  tasks:
    - name: Check if installed
      stat:
        path: "{{ k9s_dir }}/k9s"
      register: __k9s_is_installed

    - name: Get current version
      command: "{{ k9s_dir }}/k9s version --short"
      args:
        warn: false
      changed_when: false
      register: __k9s_version_output
      when: __k9s_is_installed.stat.exists

    - when:
        ( not __k9s_is_installed.stat.exists ) or
        ( __k9s_version_output.stdout_lines[0].split(" ")[-1] != k9s_version )
      block:
        - name: Get checksum list
          set_fact:
            __k9s_checksums: "{{ lookup('url', 'https://github.com/derailed/k9s/releases/download/' + k9s_version + '/checksums.txt', wantlist=True) | list }}"
          run_once: true

        - name: Get checksum for {{ ansible_architecture }} architecture
          set_fact:
            __k9s_checksum: "{{ item.split(' ')[0] }}"
          with_items: "{{ __k9s_checksums }}"
          when:
            - "( ansible_system + '_' + ansible_architecture + '.tar.gz') in item"

        - name: Download
          get_url:
            url: "https://github.com/derailed/k9s/releases/download/{{ k9s_version }}/k9s_{{ ansible_system }}_{{ ansible_architecture }}.tar.gz"
            dest: /tmp/k9s_{{ ansible_system }}_{{ ansible_architecture }}.tar.gz
            checksum: "sha256:{{ __k9s_checksum }}"

        - name: Install
          unarchive:
            src: /tmp/k9s_{{ ansible_system }}_{{ ansible_architecture }}.tar.gz
            dest: "{{ k9s_dir }}"
            remote_src: true
            extra_opts:
              - k9s  # only extract the binary
