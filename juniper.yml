---

# requires xmltodict: pip3 install xmltodict
# check inventory for endpoint, especially on first run

- hosts: juniper

  gather_facts: false
  connection: ansible.netcommon.netconf

  vars:
    juniper_l3_interfaces:
      - unit: 0
        name: vlan
        ipv4:
          - address: "{{ networks.lan.subnet | ansible.utils.nthhost(2) }}/{{ networks.lan.subnet | ansible.utils.ipaddr('prefix') }}"
      - unit: 1
        name: vlan
        ipv4:
          - address: "{{ networks.mgmt.subnet | ansible.utils.nthhost(2) }}/{{ networks.mgmt.subnet | ansible.utils.ipaddr('prefix') }}"

    # access = .vlan
    # trunk = .name
    juniper_l2_interfaces:
      -
        port: "0"
        description: "homeserver-ipmi"
        access: "{{ networks.mgmt.vlan }}"
      -
        port: "1"
        description: "cam-01"
        access: "{{ networks.iot.vlan }}"
      -
        port: "2"
        description: "cam-02"
        access: "{{ networks.iot.vlan }}"
      -
        port: "3"
        description: "cam-03"
        access: "{{ networks.iot.vlan }}"
      -
        port: "4"
        description: "cam-04"
        access: "{{ networks.iot.vlan }}"
      -
        port: "5"
        description: "cam-05"
        access: "{{ networks.iot.vlan }}"
      -
        port: "6"
        description: "cam-06"
        access: "{{ networks.iot.vlan }}"
      -
        port: "7"
        description: "cam-07"
        access: "{{ networks.iot.vlan }}"
      -
        port: "8"
        description: "cam-08"
        access: "{{ networks.iot.vlan }}"
      -
        port: "9"
        description: "cam-09"
        access: "{{ networks.iot.vlan }}"
      -
        port: "10"
        description: "cam-10"
        access: "{{ networks.iot.vlan }}"
      -
        port: "11"
        description: "cam-11"
        access: "{{ networks.iot.vlan }}"
      -
        port: "20"
        description: "testing-0"
        access: "{{ networks.user.vlan }}"
      -
        port: "21"
        description: "testing-1"
        access: "{{ networks.user.vlan }}"
      -
        port: "22"
        description: "testing-2"
        access: "{{ networks.user.vlan }}"
      -
        port: "23"
        description: "testing-3"
        access: "{{ networks.user.vlan }}"
      -
        port: "24"
        description: "master-bedroom"
        access: "{{ networks.iot.vlan }}"
      -
        port: "25"
        description: "calvins-study"
        access: "{{ networks.user.vlan }}"
      -
        port: "26"
        description: "living-room"
        access: "{{ networks.iot.vlan }}"
      -
        port: "27"
        description: "reserved-1"
        access: "{{ networks.user.vlan }}"
      -
        port: "28"
        description: "reserved-2"
        access: "{{ networks.user.vlan }}"
      -
        port: "29"
        description: "reserved-3"
        access: "{{ networks.user.vlan }}"
      -
        port: "30"
        description: "doorbell"
        access: "{{ networks.iot.vlan }}"
      -
        port: "31"
        description: "linktap-gateway-1"
        access: "{{ networks.iot.vlan }}"
      -
        port: "37"
        description: "homelab-ipmi"
        access: "{{ networks.mgmt.vlan }}"
      -
        port: "38"
        description: "opnsense-lan"
      -
        port: "39"
        description: "opnsense-vlan"
        trunk:
          - "{{ networks.mgmt.name }}"
          - "{{ networks.user.name }}"
          - "{{ networks.iot.name }}"
          - "{{ networks.pub.name }}"
          - "{{ networks.guest.name }}"
      -
        port: "40"
        description: "wifi-01"
        access: "{{ networks.mgmt.vlan }}"
        trunk:
          - "{{ networks.user.name }}"
          - "{{ networks.iot.name }}"
          - "{{ networks.guest.name }}"
        duplex: "full-duplex"
        speed: "1g"
      -
        port: "41"
        description: "wifi-02"
        access: "{{ networks.mgmt.vlan }}"
        trunk:
          - "{{ networks.user.name }}"
          - "{{ networks.iot.name }}"
          - "{{ networks.guest.name }}"
        duplex: "full-duplex"
        speed: "1g"
      -
        port: "42"
        description: "wifi-03"
        access: "{{ networks.mgmt.vlan }}"
        trunk:
          - "{{ networks.user.name }}"
          - "{{ networks.iot.name }}"
          - "{{ networks.guest.name }}"
        duplex: "full-duplex"
        speed: "1g"
      -
        port: "43"
        description: "wifi-04"
        access: "{{ networks.mgmt.vlan }}"
        trunk:
          - "{{ networks.user.name }}"
          - "{{ networks.iot.name }}"
          - "{{ networks.guest.name }}"
        duplex: "full-duplex"
        speed: "1g"
      -
        port: "44"
        description: "octopi"
        access: "{{ networks.iot.vlan }}"
      -
        port: "45"
        description: "printer"
        access: "{{ networks.user.vlan }}"
      -
        port: "46"
        description: "smlight-slzb-06m"
        access: "{{ networks.iot.vlan }}"
      -
        port: "47"
        description: "alarm"
        access: "{{ networks.iot.vlan }}"
      -
        interface: xe
        port: "0"
        description: "homelab-sfp"
        trunk:
          - "{{ networks.mgmt.name }}"
          - "{{ networks.user.name }}"
          - "{{ networks.iot.name }}"
          - "{{ networks.pub.name }}"
          - "{{ networks.guest.name }}"
      -
        interface: xe
        port: "1"
        description: "nvr-sfp"
        access: "{{ networks.iot.vlan }}"
      -
        interface: xe
        port: "3"
        description: "engenius-10g-switch"
        trunk:
          - "{{ networks.mgmt.name }}"
          - "{{ networks.user.name }}"
          - "{{ networks.iot.name }}"
          - "{{ networks.pub.name }}"
          - "{{ networks.guest.name }}"

  tasks:
    - name: Enable netconf service
      junipernetworks.junos.junos_netconf:
        state: present
      connection: ansible.netcommon.network_cli

    - name: Configure system identity
      junipernetworks.junos.junos_system:
        hostname: juniper
        domain_name: "{{ common_local_tld }}"
        domain_search:
          - "{{ common_local_tld }}"
        name_servers:
          - "{{ networks.mgmt.subnet | ansible.utils.ipaddr('addressname }}"

    - name: Configure Layer 3 interfaces
      junipernetworks.junos.junos_l3_interfaces:
        config: "{{ juniper_l3_interfaces }}"
        state: merged

    - name: Configure routing
      junipernetworks.junos.junos_static_routes:
        config:
          - address_families:
              - afi: ipv4
                routes:
                  - dest: 0.0.0.0/0
                    next_hop:
                      - forward_router_address: "{{ networks.mgmt.subnet | ansible.utils.nthhost(1) }}"
        state: merged

    - name: Configure VLANs
      junipernetworks.junos.junos_vlans:
        config: "{{ networks | to_juniper_vlan_config }}"
        state: merged

    # - name: Gather junos layer 2 interfaces as in given arguments
    #   junipernetworks.junos.junos_l2_interfaces:
    #     state: gathered

    - name: Configure Layer 2 interfaces
      junipernetworks.junos.junos_l2_interfaces:
        config: "{{ juniper_l2_interfaces | to_juniper_l2_config }}"
        state: replaced

    - name: Configure ports
      junipernetworks.junos.junos_interfaces:
        config: "{{ juniper_l2_interfaces | to_juniper_interface_config }}"
        state: merged

    - name: Disable 'Management Ethernet Link Down' alarm
      junipernetworks.junos.junos_command:
        commands:
          - configure
          - set chassis alarm management-ethernet link-down ignore
          - commit and-quit
        display: text
      connection: ansible.netcommon.network_cli
