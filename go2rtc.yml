---

- hosts: homeserver

  vars:
    application: go2rtc

    container_network: "{{ networks.iot }}"

  handlers:
    - name: Restart
      containers.podman.podman_container:
        name: "{{ application }}"
        force_restart: true

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create config
      ansible.builtin.copy:
        content: |
          streams:
            backyard: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/AKV6ed7s96ojGDU0
            downstairs_common: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/pUoYtfbCbSjvhIyR
            downstairs_hallway: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/SiIzjZyICCOaM23e
            driveway: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/Lb2Mn8bzxrwIAzFH
            foyer: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/QfbyJT2WbsWBUqXU
            front_bedrooms: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/CwFM91PCiKat6Z7T
            garage: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/hmXnXbDRoF573SZ4
            outdoor_side: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/zUs5nXcCogxPqbzi
            rear_balcony: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/E82ebu7JnaHYUv9u
            upstairs_hallway: rtsp://{{ networks.iot.subnet | ansible.utils.nthhost(255) }}:7447/QGDEqJaMlkK8volh

            reolink_doorbell:
              - rtsp://admin:{{ reolink_doorbell_password }}@reolink-doorbell.{{ common_local_tld }}:554/h264Preview_01_sub
        dest: "{{ config_directory }}/go2rtc.yaml"
        mode: "0660"
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
      notify: Restart
      vars:
        reolink_doorbell_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36373330303162383736366263383435616539303963373535333261343662333962366665656436
          3064303337643030326265623963326461366161663932360a323236316161353165303034633038
          36663633363032326230356663666632653463666636306262656164396130623731323036626433
          3839323164626664350a636634356566323465653937626664306539383930383630613639363235
          34633362333461336538366633633236326233343866306437626331396232643566

    - name: Create container
      ansible.builtin.include_role:
        name: podman_container
      vars:
        image: ghcr.io/alexxit/go2rtc:1.9.12-hardware
        ip: "{{ container_network.subnet | ansible.utils.nthhost(102) }}"
        privileged: true
        env:
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ config_directory }}:/config"
        device:
          - /dev/dri:/dev/dri
