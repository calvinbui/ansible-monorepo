---

- hosts: homelab

  vars:
    application: gpt4all

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Clone repo
      ansible.builtin.git:
        repo: https://github.com/nomic-ai/gpt4all-ui.git
        dest: "{{ config_directory }}"
        update: true
        force: true
      register: _gpt4all_repo_updated

    - name: Download models
      ansible.builtin.get_url:
        url: "{{ item.url }}"
        dest: "{{ config_directory }}/models/{{ item.type }}/"
      loop:
        -
          type: llama_cpp
          url: https://gpt4all.io/models/ggml-gpt4all-l13b-snoozy.bin
        -
          type: llama_cpp
          url: https://huggingface.co/ParisNeo/GPT4All/resolve/main/gpt4all-lora-quantized-ggml.bin

    - name: Replace http with https
      ansible.builtin.replace:
        path: "{{ config_directory }}/static/js/websocket.js"
        regexp: 'http'
        replace: 'https'

    - name: Build image
      community.docker.docker_image:
        name: "{{ application }}"
        build:
          path: "{{ config_directory }}"
          dockerfile: Dockerfile
          pull: true
        source: build
        state: present
        force_source: "{{ true if _gpt4all_repo_updated.changed else false }}"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: "{{ application }}"
        volumes:
          - "{{ config_directory }}/data:/srv/data"
          - "{{ config_directory }}/data/.nomic:/root/.nomic/"
          - "{{ config_directory }}/models:/srv/models"
          - "{{ config_directory }}/configs:/srv/configs"
          - "{{ config_directory }}/personalities:/srv/personalities"
        traefik:
          - port: 9600
            auth: page
