---

- hosts: homelab

  vars:
    application: lobechat

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_root_group }}"
        mode: "0771"

    - name: Create postgres container
      ansible.builtin.include_role:
        name: postgres
      vars:
        postgres_image: pgvector/pgvector
        postgres_version: 0.7.4-pg16
        postgres_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34373237303439613461353433383530653264383761633131363639343936373861386361656636
          3037636633656266393536653263633430383934373437340a323464333765376162653061353637
          37616434613738376534616464623630376466373262333239656433313361393562393636393861
          3339373266633766380a653536316362353632363236653339346431666363366234303661656263
          61346362376566366635363061376564363565633066633564626235613233383162

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: lobehub/lobe-chat-database:v1.47.4
        env:
          APP_URL: "https://{{ application }}.{{ common_tld }}"

          KEY_VAULTS_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            64616662393936616134366337666237666531323235613761663565663237313164393164666334
            6366383665613365653966666564666564383734376165310a363537623931376634613139396333
            37363039623336376432306634393234316139633634613835356236613265366536333164336230
            3939303664376631650a353330363138626436336164356164316538323030303163316563636333
            33353361643731373266333935346633353534346336363837356238613565623333613137646131
            3734306531616634326232306363636565323437383236376535

          DATABASE_URL: "{{ _postgres_url }}"

          NEXTAUTH_URL: "https://{{ application }}.{{ common_tld }}/api/auth"
          NEXT_AUTH_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            37643761313462376363613630363865303164326465626565313239306664656239633365363938
            6530656338316666373861666637666436623162393736330a363038386633666664656537316461
            35393630393036663334653834323933623165613332616562363638363930633231393763303339
            6237393066306432640a653065343337343163333665636530306534656535326230333661656236
            35633035313930623532633232336331393961303733303730356262616530393463646561376237
            6566366139396537323436613634616330643037643066643162
          NEXT_AUTH_SSO_PROVIDERS: "{{ oidc_provider }}"
          AUTH_AUTHELIA_ID: "{{ application }}"
          AUTH_AUTHELIA_SECRET: "{{ oidc_auth.lobechat.secret }}"
          AUTH_AUTHELIA_ISSUER: "{{ oidc_base_url }}"

          S3_ACCESS_KEY_ID: "Zj6owhhQcfvPN6bqiyqQ"
          S3_SECRET_ACCESS_KEY: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            30646337643237366263666437383863633862386239336633643931326637316333663161643639
            6533313765383036386239613633333065616562393834320a666431623861613137333737373361
            36623438376566343430303539616337663566306164613236613136346264623866343864376264
            3366653232316532340a336239613764343935363238636665333962643033306362313662383635
            62666365333061353037373632396365353133663664323732376466633634323934306664613565
            6261666361666430323837303763636663373436303662363535
          S3_ENDPOINT: "https://minio.{{ common_tld }}"
          S3_BUCKET: "{{ application }}"
          S3_PUBLIC_DOMAIN: "https://minio.{{ common_tld }}"
          S3_ENABLE_PATH_STYLE: "1"

          OPENAI_API_KEY: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            38353035343430353935343833333633613963393761316135633364343462343938323630323230
            6631373539313066363636333139346435316132366639320a333239356539363438633363666364
            34626534356466326137396364616365386330326330643134333264346362303330613462666436
            3662386237353266610a366162656561313966363631353534313966393233616430356262333866
            66613561386661636437356334306565383433623961393833343563656165353839663032653364
            34313637393364613662633033356335323333303038626662386436373030636664313864356664
            616566353630626234353839336535656261
          ENABLED_OLLAMA: "0"
        volumes:
          - "{{ config_directory }}/app:/app/backend/data"
        traefik:
          - port: 3210
        homepage:
          name: LobeChat
          group: Tools
          weight: 150
          description: "AI Chat"
