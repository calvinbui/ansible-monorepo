---

- hosts: homelab

  vars:
    application: mattermost

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config directory
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user_id }}"
        group: "{{ common_root_group }}"
        mode: "0771"
      register: _config_dir

    - name: Create postgres container
      ansible.builtin.include_role:
        name: postgres
      vars:
        postgres_version: 12
        postgres_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66636138626433383439313439353435373036616161646536333333363464383163336361613931
          3361653330393532623865393836336434363162663635330a323366346464326634373038366630
          38323236366237633331306434366464666564376337623930386163323466623538393037333131
          6234393131386537310a346562323563663637393763653961376137613538316638653165363637
          38646136363563656132303534333630343136363536343666663230633466333736

    - name: Create app directories
      ansible.builtin.file:
        path: "{{ _config_dir.path }}/mattermost/{{ item }}"
        state: directory
        recurse: true
        owner: "2000"
        group: "2000"
      loop:
        - config
        - data
        - logs
        - plugins
        - client-plugins
      register: _dir

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: mattermost/mattermost-team-edition:5
        volumes:
          - "{{ _dir.results | selectattr('item', 'match', 'config') | flatten | map(attribute='path') | first }}:/mattermost/config"
          - "{{ _dir.results | selectattr('item', 'match', 'data') | flatten | map(attribute='path') | first }}:/mattermost/data"
          - "{{ _dir.results | selectattr('item', 'match', 'logs') | flatten | map(attribute='path') | first }}:/mattermost/logs"
          - "{{ _dir.results | selectattr('item', 'match', 'plugins') | flatten | map(attribute='path') | first }}:/mattermost/plugins"
          - "{{ _dir.results | selectattr('item', 'match', 'client-plugins') | flatten | map(attribute='path') | first }}:/mattermost/client/plugins"
          - /etc/localtime:/etc/localtime:ro
        env:
          # set same as db credentials and dbname
          MM_USERNAME: "{{ _postgres_username }}"
          MM_PASSWORD: "{{ _postgres_password }}"
          MM_DBNAME: "{{ _postgres_database }}"
          DB_HOST: "{{ _postgres_hostname }}"
          DB_PORT_NUMBER: "5432"
          MM_SQLSETTINGS_DRIVERNAME: postgres
          MM_SQLSETTINGS_DATASOURCE: "{{ _postgres_url }}?sslmode=disable&connect_timeout=10"
        traefik:
          - port: 8065
        homer:
          name: Mattermost
          service: Collaboration
          priority: 890
          subtitle: "Online chat"
