---

- hosts: homelab

  vars:
    application: vmalert

    docker_network: "{{ vm_network }}"

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "1000"
        group: "50"
        mode: "0755"

    - name: Copy rules
      block:
        - name: Synchronise rules
          ansible.posix.synchronize:
            src: "{{ files_directory }}/"
            dest: "{{ config_directory }}/"
            delete: true
            owner: false
            group: false

        - name: Take ownership of rules
          ansible.builtin.file:
            path: "{{ config_directory }}/"
            state: directory
            recurse: true
            owner: "1000"
            group: "50"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: victoriametrics/vmalert:v1.93.4
        command:
          - -rule=/rules/*
          - -configCheckInterval=60s
          - -evaluationInterval=60s

          - "-notifier.url=http://alertmanager.{{ vm_network.name }}:9093"

          - "-datasource.url=http://victoriametrics.{{ vm_network.name }}:8428"
          - "-remoteWrite.url=http://victoriametrics.{{ vm_network.name }}:8428"
          - "-remoteRead.url=http://victoriametrics.{{ vm_network.name }}:8428"

          - "-external.url=https://{{ application }}.{{ common_tld }}"
        volumes:
          - "{{ config_directory }}:/rules"
        traefik:
          - port: 8880
            auth: page
        homepage:
          name: vmalert
          group: Monitoring
          weight: 401
          description: "VictoriaMetrics alerting"
        blackbox:
          path: /-/healthy
        metrics:
          - port: 8880
