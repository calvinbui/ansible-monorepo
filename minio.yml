---

- hosts: homelab

  vars:
    application: minio

    minio_user: 3fiCArUB7qYUPiqBcJGS
    minio_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39343030393438393162313362353633646239356433366430643961633132343337373131666138
      6331663530373364613431396638643932383438333330310a306336633837666463363161373662
      35386639666164346439663532373732373037643165393464663662326564323562356461613262
      6331323639396236390a383332643161353961313237346334613832633766636164376363653664
      63663633646633353164373666303635363762653862626530623838326162393061393661656234
      31346136646538333834626564646139613061666466343161303735636633373537656130323635
      32653732663738323665666563653437376235326534303733633662333233616463646566323737
      35376237343864333036

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: minio/minio:RELEASE.2024-02-26T09-33-48Z
        command:
          - server
          - --anonymous
          - --console-address
          - ":9090"
          - /data
        env:
          MINIO_ROOT_USER: "{{ minio_user }}"
          MINIO_ROOT_PASSWORD: "{{ minio_password }}"

          MINIO_SERVER_URL: "https://{{ application }}.{{ common_tld }}"
          MINIO_BROWSER_REDIRECT_URL: "https://{{ application }}-console.{{ common_tld }}"

          MINIO_IDENTITY_OPENID_ENABLE: "on"
          MINIO_IDENTITY_OPENID_COMMENT: "authentik"
          MINIO_IDENTITY_OPENID_CONFIG_URL: "https://authentik.{{ common_tld }}/application/o/{{ application }}/.well-known/openid-configuration"
          MINIO_IDENTITY_OPENID_CLIENT_ID: "{{ application }}"
          MINIO_IDENTITY_OPENID_CLIENT_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            32623435636165373931333639363965363536373938366162363736363331656362613438613534
            3636323036623064383037303165396637383639313930640a616633626135373731633938316131
            30336564633231346365663633393735613836623161373930303238326234616637366236313436
            3333346466616564630a616162666432623530336436353934303865386237353834613762363331
            37346535303065343332363732356639623831613364343934343137633331313436323665343036
            36626662353633643065393134643264363266626434396135633331666433626266336235303661
            62653237666333616463376236306565323666303030363236396438316537616436656439343035
            66373964613432366666306262646331646165333932633139383631336261356134356638633561
            65373930383033626361333165613332643631646261376635353964656438613434363633623834
            66616134636637326136363133626533656330646261326334316530323230393461303733623936
            326662623337316635616466653364396462
          MINIO_IDENTITY_OPENID_DISPLAY_NAME: "authentik"
          MINIO_IDENTITY_OPENID_CLAIM_PREFIX: "authentik"
          MINIO_IDENTITY_OPENID_SCOPES: "openid,profile,email"
          MINIO_IDENTITY_OPENID_ROLE_POLICY: "consoleAdmin"
          MINIO_IDENTITY_OPENID_REDIRECT_URI: "https://{{ application }}-console.{{ common_tld }}/oauth_callback"
        volumes:
          - "{{ config_directory }}/data:/data"
        traefik:
          - name: "{{ application }}-console"
            port: 9090
          - port: 9000
        blackbox:
          path: /login
        homepage:
          name: MinIO
          group: Storage
          weight: 400
          description: "Object storage"
          href: "https://{{ application }}-console.{{ common_tld }}"
