---

- hosts: homelab

  vars:
    application: minio

    minio_user: 3fiCArUB7qYUPiqBcJGS
    minio_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39343030393438393162313362353633646239356433366430643961633132343337373131666138
      6331663530373364613431396638643932383438333330310a306336633837666463363161373662
      35386639666164346439663532373732373037643165393464663662326564323562356461613262
      6331323639396236390a383332643161353961313237346334613832633766636164376363653664
      63663633646633353164373666303635363762653862626530623838326162393061393661656234
      31346136646538333834626564646139613061666466343161303735636633373537656130323635
      32653732663738323665666563653437376235326534303733633662333233616463646566323737
      35376237343864333036

    docker_network: "{{ networks.pub }}"

  handlers:
    - name: Restart mc
      ansible.builtin.command: docker restart "{{ application }}-mc"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"
      register: _config_dir

    - name: Create minio container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: minio/minio
        command:
          - server
          - /data
          - --console-address ":9001"
        env:
          MINIO_ROOT_USER: "{{ minio_user }}"
          MINIO_ROOT_PASSWORD: "{{ minio_password }}"

          MINIO_SERVER_URL: "https://{{ application }}.{{ common_tld }}"

          MINIO_BROWSER_REDIRECT_URL: "https://{{ application }}-console.{{ common_tld }}"
        volumes:
          - "{{ _config_dir.path }}/data:/data"
        traefik:
          # api
          - name: "{{ application }}-api"
            port: 9000
            rule: Host(`{{ application }}.{{ common_tld }}`)
          # console
          - name: "{{ application }}-console"
            port: 9001
            rule: Host(`{{ application }}-console.{{ common_tld }}`)
        homer:
          name: MinIO
          service: Sharing
          priority: 590
          subtitle: "Object storage"
          url: "https://{{ application }}-console.{{ common_tld }}"

    - name: Create mc config
      notify: Restart mc
      ansible.builtin.copy:
        dest: "{{ _config_dir.path }}/config.json"
        content: |
          {
            "version": "10",
            "aliases": {
              "minio": {
                "url": "http://{{ application }}.{{ docker_network.name }}:9000",
                "accessKey": "{{ minio_user }}",
                "secretKey": "{{ minio_password }}",
                "api": "S3v4",
                "path": "auto"
              }
            }
          }

    - name: Create mc container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-mc"
        entrypoint:
          - tail
          - -f
          - /dev/null
        image: minio/mc
        volumes:
          - "{{ _config_dir.path }}/config.json:/root/.mc/config.json"
