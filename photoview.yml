---
- hosts: homelab

  vars:
    application: photoview

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create mariadb container
      ansible.builtin.include_role:
        name: mariadb
      vars:
        mariadb_version: 10
        mariadb_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34346439626661333062323932346430373735636666636233373266383262313839343561323465
          3531616564643231356663326533643331393361353065310a656631363763363633663362653965
          33353636616163613136306464313334633837666530633866656666643762633666653938623862
          3062373665353139630a336532623137393763353935663632653838643963636531643732333164
          33346137666138323530376435643635363561663534666463363238353638623964

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: viktorstrate/photoview:2
        env:
          PHOTOVIEW_LISTEN_IP: 0.0.0.0
          PHOTOVIEW_DATABASE_DRIVER: mysql
          PHOTOVIEW_MYSQL_URL: "{{ _mariadb_username }}:{{ _mariadb_password }}@tcp({{ _mariadb_hostname }})/{{ _mariadb_database }}"

          PHOTOVIEW_DISABLE_FACE_RECOGNITION: "1"
        volumes:
          - "{{ config_directory }}/cache:/app/photo_cache"

          - "/mnt/files/Photos/WeddingGrouped:/photos:ro"
        traefik:
          - port: 80
