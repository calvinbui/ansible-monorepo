---

- hosts: homelab

  vars:
    application: omada

    docker_network: "{{ networks.user }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user_id }}"
        group: "{{ common_root_group }}"
        mode: "0771"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: mbentley/omada-controller:5.9-chromium
        env:
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ config_directory }}/cert:/cert"
          - "{{ config_directory }}/data:/opt/tplink/EAPController/data"
          - "{{ config_directory }}/work:/opt/tplink/EAPController/work"
          - "{{ config_directory }}/logs:/opt/tplink/EAPController/logs"
        ipv4_address: "{{ docker_network.prefix }}.3"
        homepage:
          name: TP-Link Omada Controller
          group: Networking
          weight: 400
          description: "Manage TP-Link EAPs"
          href: https://omada.{{ common_local_tld }}:8043
          widget:
            username: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              64613534616663633634386566646664396364656261656461633665623232626535363033366638
              3834383163303366643034356466313534323230366661370a616465326635336363613936626333
              65313761343464336436316230653638363232633733363038313834343664346438363661633433
              3666353465353239360a396637666663363639356131636636303138396431663764636230623161
              3363
            password: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              32373334616634356361303934356135616638393237376637346161313238633966343764343966
              6335623035373234373739643665393931626135666164360a646338636437323934313463326435
              66373266383431323734333235623566363866656639383638376336393034663636616238306139
              3434313639353437640a373037396535616638393963663031653630656563326133333466616266
              65383636346366303564396536656566393136653762326132636566613962333864
            site: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              64356264653566313037383662653061373463643937666363326237656436323363363337336234
              3261383331346236646561623166333231666565616337660a336331363064313835633163656262
              31393362303632616265353666666331326638396531616338636138386332323066396537336364
              6639393337303031390a306637623862336230653461653233613733323532303466303134323461
              3864
            fields: '["connectedAp", "activeUser", "alerts"]'
