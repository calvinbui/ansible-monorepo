---
- hosts: duplicati
  become: true
  vars:
    network: "{{ networks.pub }}"
    duplicati_config_directory: "{{ common_directory }}/duplicati"
    duplicati_backup_directory: "/backups"
    duplicati_source_directory: "{{ common_directory }}"
  module_defaults:
    docker_container:
      restart_policy: unless-stopped
      networks_cli_compatible: true
      purge_networks: true
      dns_servers: "{{ network.dns }}"
      networks:
        - name: "{{ network.name }}"
  tasks:
    - name: Copy Duplicati run file
      copy:
        src: duplicati/run
        dest: "{{ duplicati_config_directory }}/run"
    - name: Create Duplicati container
      docker_container:
        name: duplicati
        image: linuxserver/duplicati
        state: started
        networks:
          - name: "{{ networks.pub.name }}"
            ipv4_address: "{{ network.prefix }}.30"
        env:
          PUID: "{{ common_root_id }}"
          PGID: "{{ common_root_group }}"
          TZ: "{{ common_timezone }}"
          CLI_ARGS: "--webservice-sslcertificatefile=/config/cert.pfx --webservice-sslcertificatepassword=pass"
        volumes:
          - "{{ duplicati_config_directory }}:/config"
          - "{{ duplicati_backup_directory }}:/backups"
          - "{{ duplicati_source_directory }}:/source:ro"
          - "{{ duplicati_config_directory }}/run:/etc/services.d/duplicati/run"
        labels:
          traefik.enable: "false"
        comparisons:
          env: strict
          volumes: strict
