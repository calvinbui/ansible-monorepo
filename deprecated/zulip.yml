---
- hosts: zulip
  become: true
  vars:
    network: "{{ networks.pub }}"
  module_defaults:
    docker_container:
      keep_volumes: false
      state: started
      restart_policy: unless-stopped
      networks_cli_compatible: true
      purge_networks: true
      networks:
        - name: "{{ network.name }}"
      dns_servers: "{{ network.dns }}"
      comparisons:
        env: allow_more_present
        labels: allow_more_present
  roles:
    - postgres
    - memcached
    - rabbitmq
    - redis
  tasks:
    - name: Create Zulip container
      docker_container:
        name: zulip
        image: zulip/docker-zulip:2.1.2-0
        volumes:
          - "{{ common_directory }}/zulip/zulip:/data"
        env:
          DB_HOST: "{{ postgres_name }}.{{ network.name }}"
          DB_HOST_PORT: '5432'
          DB_USER: "{{ postgres_environment_variables.POSTGRES_USER }}"
          SSL_CERTIFICATE_GENERATION: 'self-signed'
          DISABLE_HTTPS: 'True'
          SETTING_MEMCACHED_LOCATION: "{{ memcached_name }}.{{ network.name }}:11211"
          SETTING_RABBITMQ_HOST: "{{ rabbitmq_name }}.{{ network.name }}"
          SETTING_REDIS_HOST: "{{ redis_name }}.{{ network.name }}"
          SECRETS_email_password: "{{ common_email_password }}"
          # These should match RABBITMQ_DEFAULT_PASS, POSTGRES_PASSWORD,
          # MEMCACHED_PASSWORD, and REDIS_PASSWORD above.
          SECRETS_rabbitmq_password: "{{ rabbitmq_environment_variables.RABBITMQ_DEFAULT_PASS }}"
          SECRETS_postgres_password: "{{ postgres_environment_variables.POSTGRES_PASSWORD }}"
          SECRETS_memcached_password: "{{ memcached_environment_variables.MEMCACHED_PASSWORD }}"
          SECRETS_redis_password: "{{ redis_environment_variables.REDIS_PASSWORD }}"
          SECRETS_secret_key: "{{ zulip_secret_key }}"
          SETTING_EXTERNAL_HOST: "zulip.{{ common_tld }}"
          SETTING_ZULIP_ADMINISTRATOR: "zulip{{ common_email_to }}"
          SETTING_EMAIL_HOST: "{{ common_email_server }}"
          SETTING_EMAIL_HOST_USER: "{{ common_email_username }}"
          SETTING_EMAIL_PORT: "{{ common_email_smtp_port }}"
          # It seems that the email server needs to use ssl or tls and can't be used without it
          SETTING_EMAIL_USE_SSL: 'False'
          SETTING_EMAIL_USE_TLS: 'True'
          ZULIP_AUTH_BACKENDS: 'EmailAuthBackend'
          # Uncomment this when configuring the mobile push notifications service
          SETTING_PUSH_NOTIFICATION_BOUNCER_URL: 'https://push.zulipchat.com'
        labels:
          traefik.http.routers.zulip.entrypoints: "web"
          traefik.http.routers.zulip.middlewares: "redirect@file"
          traefik.http.routers.zulip-secure.entrypoints: "web-secure"
          traefik.http.routers.zulip-secure.tls: "true"
          traefik.http.routers.zulip-secure.tls.certresolver: letsencrypt
          traefik.http.services.zulip.loadbalancer.server.port: "80"
