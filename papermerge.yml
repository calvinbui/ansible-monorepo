---

- hosts: homelab

  vars:
    application: papermerge

    docker_network: "{{ networks.pub }}"

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Add user
      ansible.builtin.user:
        name: "{{ application }}"
        create_home: false
        home: "{{ config_directory }}/import"
        password: "$6$GbBqXO8BE$3gAl2uWHvBWdSUYl1EpTCYjJuGzi4HnlQlTmmbyOpbw6jNwZRwiDZ8.ADiyO9j/i2HyknE6jh3PYIlg7DrD.i/"
      register: _papermerge_user

    - name: Create config directory
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ _papermerge_user.uid }}"
        group: "{{ common_group_id }}"
        mode: "0750"

    - name: Create folders
      ansible.builtin.file:
        path: "{{ config_directory }}/{{ item }}"
        state: directory
        owner: "{{ _papermerge_user.uid }}"
        group: "{{ common_group_id }}"
        mode: "0750"
      loop:
        - config
        - data
        - import

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: lscr.io/linuxserver/papermerge:2.0.1
        volumes:
          - "{{ config_directory }}/config:/config"
          - "{{ config_directory }}/data:/data"
          - "{{ config_directory }}/import:/import"
        env:
          PUID: "{{ _papermerge_user.uid | string }}"
          PGID: "{{ common_group_id | string }}"
          TZ: "{{ common_timezone }}"
        traefik:
          - port: 8000
        homer:
          name: Papermerge
          service: Tools
          priority: 490
          subtitle: "Document scanner"

    - name: Edit config
      ansible.builtin.lineinfile:
        path: "{{ config_directory }}/config/papermerge.conf.py"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - regexp: "IMPORTER_DIR"
          line: 'IMPORTER_DIR = "/import"'
        - regexp: "BINARY_STAPLER"
          line: 'BINARY_STAPLER = "/usr/local/bin/stapler"'
      notify: Restart
