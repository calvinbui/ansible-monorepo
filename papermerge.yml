---

- hosts: homelab

  become: true

  vars:
    application: papermerge

    docker_network: "{{ networks.pub }}"

  handlers:
    - name: Restart
      ansible.builtin.command: docker restart "{{ application }}"

  tasks:
    - name: Create folders
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "papermerge"
        group: "{{ common_group_id }}"
        mode: "0775"
      loop:
        - "{{ config_directory }}"
        - "{{ config_directory }}/config"
        - "{{ config_directory }}/data"
        - "{{ config_directory }}/import"

    - name: Add user
      ansible.builtin.user:
        name: papermerge
        create_home: false
        home: "{{ config_directory }}/import"
        password: "$6$vgLah.l13sGfNWEP$/vrPocaGTCDC601velsai68JfVzIzaQ18OrO0Y8Q2FPpey7kmXfx/fwZcJQkLPkbnJ2SIS.S.CLBbP8iB4MfS0"
      register: papermerge_user

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: ghcr.io/linuxserver/papermerge:latest
        volumes:
          - "{{ config_directory }}/config:/config"
          - "{{ config_directory }}/data:/data"
          - "{{ config_directory }}/import:/import"
        env:
          PUID: "{{ papermerge_user.uid }}"
          PGID: "{{ common_group_id }}"
          TZ: "{{ common_timezone }}"
        traefik:
          - port: "8000"

    - name: Edit config
      ansible.builtin.lineinfile:
        path: "{{ config_directory }}/config/papermerge.conf.py"
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - regexp: "IMPORTER_DIR"
          line: 'IMPORTER_DIR = "/import"'
        - regexp: "BINARY_STAPLER"
          line: 'BINARY_STAPLER = "/usr/local/bin/stapler"'
      notify: Restart
