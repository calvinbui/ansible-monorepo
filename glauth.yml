---

- hosts: homelab

  vars:
    application: glauth

    ui_secret_key: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      34323739613031306166633535366632653930363064346438663736626637323935386337373031
      3338376231613432323537346636623163363863373233320a376631313634646139643534616464
      32343064346637326563623763393833376665343535623631343566323061616634333161316432
      3337303763613137380a393030613432316265386264323135326262343331646438303738316163
      39373436666131626132633563613165393434653539626361333664346439316363

    docker_network: "{{ networks.mgmt }}"

  handlers:
    - name: Restart
      ansible.builtin.command: docker restart "{{ application }}"

  tasks:
    - name: Create config folders
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"
      register: _config_dir

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: glauth/glauth
        volumes:
          - "{{ _config_dir.path }}/config:/app/config"

    - name: Touch config
      notify: Restart
      ansible.builtin.file:
        dest: "{{ _config_dir.path }}/config/config.cfg"
        mode: "0644"
        owner: "{{ common_user_id }}"
        group: "{{ common_group_id }}"

    - name: Clone UI
      ansible.builtin.git:
        repo: 'https://github.com/sonicnkt/glauth-ui.git'
        dest: "{{ _config_dir.path }}/glauth-ui"
        update: true

    - name: Build UI image
      community.docker.docker_image:
        name: "{{ application }}-ui"
        build:
          path: "{{ _config_dir.path }}/glauth-ui"
          dockerfile: Dockerfile
          pull: true
          network: "{{ docker_network.name }}"
        source: build
        state: present

    - name: Create UI container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-ui"
        image: "{{ application }}-ui"
        volumes:
          - "{{ _config_dir.path }}/config:/home/ldap/db"
        env:
          SECRET_KEY: "{{ ui_secret_key }}"
          MAIL_SERVER: "{{ common_email_server }}"
          MAIL_PORT: "{{ common_email_smtp_port }}"
          MAIL_USE_TLS: "{{ '1' if common_email_protocol == 'tls' else '0' }}"
          MAIL_USERNAME: "{{ common_email_username }}"
          MAIL_PASSWORD: "{{ common_email_password }}"
          MAIL_ADMIN: "{{ application }}{{ common_email_to }}"
        traefik:
          - port: 5000
            rule: "Host(`{{ application }}.{{ common_tld }}`)"
        labels:
          com.centurylinklabs.watchtower.enable: "false"
