---

- hosts: homelab

  vars:
    application: onlyoffice

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: onlyoffice/documentserver:7.3.2
        volumes:
          - "{{ config_directory  }}/logs:/var/log/onlyoffice"
          - "{{ config_directory  }}/data:/var/www/onlyoffice/Data"
          - "{{ config_directory  }}/lib:/var/lib/onlyoffice"
          - "{{ config_directory  }}/rabbitmq:/var/lib/rabbitmq"
          - "{{ config_directory  }}/redis:/var/lib/redis"
          - "{{ config_directory  }}/db:/var/lib/postgresql"
        env:
          JWT_ENABLED: "true"
          JWT_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62613932646635633462646366396438636165303466366338363166323132613938336334363633
            6465333735656137653439313233636566636330363461380a616231323438333336356233386561
            36336638383239666262346166393839396466353833306138386636333130333131313966313666
            6361663336343432610a333138353763353731393061613036336433613733626230396234356330
            33356564396233646537353237663533646133386534663166633664343966306464

          USE_UNAUTHORIZED_STORAGE: "true"
        traefik:
          - port: 80
        labels:
          '{
            "traefik.http.routers.{{ application }}-secure.middlewares": "{{ application }}-sslheaders",
            "traefik.http.middlewares.{{ application }}-sslheaders.headers.customrequestheaders.X-Forwarded-Proto": "https"
          }'
