---

# The container mounts the NVIDIA drivers.

- hosts: homelab

  vars:
    docker_network: "{{ networks.mgmt }}"

  tasks:
    # https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html
    # https://github.com/NVIDIA/ansible-role-nvidia-driver

    - name: Set distribution variable
      ansible.builtin.set_fact:
        _distribution: "{{ ansible_distribution | lower }}{{ ansible_distribution_version | regex_replace('\\.', '') }}"

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Install NVIDIA drivers
      ansible.builtin.apt:
        name:
          - "nvidia-headless-470-server"
          - "nvidia-utils-470-server"
          - "nvidia-headless-no-dkms-470-server"
          - "nvidia-kernel-source-470-server"
        state: present
      register: __install_nvidia_drivers
      until: __install_nvidia_drivers is success
      retries: 5
      delay: 5

    - name: Create persistenced override directory
      ansible.builtin.file:
        path: /etc/systemd/system/nvidia-persistenced.service.d/
        state: directory
        recurse: true

    - name: Configure persistenced service to turn on persistence mode
      ansible.builtin.copy:
        content: |
          [Service]
          ExecStart=
          ExecStart=/usr/bin/nvidia-persistenced --user root --persistence-mode --verbose
        dest: /etc/systemd/system/nvidia-persistenced.service.d/override.conf
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0644"

    - name: Enable persistenced
      ansible.builtin.service:
        name: docker
        state: started
        enabled: true

    # https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html#docker

    - name: Add NVIDIA's Docker GPG key
      ansible.builtin.apt_key:
        url: https://nvidia.github.io/nvidia-docker/gpgkey
        state: present
      retries: 5
      delay: 5

    - name: Download NVIDIA's Docker Repository
      ansible.builtin.get_url:
        url: "https://nvidia.github.io/nvidia-docker/{{ ansible_distribution | lower }}{{ ansible_distribution_version }}/nvidia-docker.list"
        dest: /etc/apt/sources.list.d/nvidia-docker.list
      register: __apt_repository

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
      when: __apt_repository.changed

    - name: Install NVIDIA Container Toolkit
      ansible.builtin.apt:
        name: nvidia-docker2
        state: present
      register: __install_nvidia_toolkit
      until: __install_nvidia_toolkit is success
      retries: 5
      delay: 5

    - name: Restart Docker to complete installation
      ansible.builtin.service:
        name: docker
        state: restarted
      when:
        - not __install_nvidia_drivers.changed
        - __install_nvidia_toolkit.changed

    - name: Reboot to load NVIDIA drivers
      ansible.builtin.reboot:
      when: __install_nvidia_drivers.changed
