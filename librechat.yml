---

- hosts: homelab

  vars:
    application: librechat

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}/{{ item }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_root_group }}"
        mode: "0771"
      loop:
        - images
        - uploads
        - logs

    - name: Create mongodb container
      ansible.builtin.include_role:
        name: mongodb
      vars:
        mongo_version: 8.0
        mongo_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          37303330326665623962396535636234373439313438393837306236313465356633373231623430
          3233633766363765346535323765333136303833343337380a323663333637656661633331343939
          64326632626238323037353439653061313964383563346539633965626137303838616466386366
          3166643664633639330a666332393933613363373433613831646365366362376236623434666264
          32323838336138353762616264393732386439613365616130653532656435353238
        mongo_command: --logpath /dev/null --quiet

    - name: Create meilisearch container
      ansible.builtin.include_role:
        name: meilisearch
      vars:
        meilisearch_version: 1.14.0
        meilisearch_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39373565323531383237613133326338666231313932626337646535303537313363363466333565
          6235633332616431626662366534346433306634666566650a666639313562623865383964383561
          30363762366563383339373637666638643631653862636134663735666639343662393931633162
          3361303165366135660a333637306634333638336133346630313032306137663234653065356139
          34383066623130313738323438323430326433623162666238333839396430366530

    - name: Create postgres container
      ansible.builtin.include_role:
        name: postgres
      vars:
        postgres_image: pgvector/pgvector
        postgres_version: 0.8.0-pg17
        postgres_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63626431336239643665633437343739666638366534353439616335623539623935353565643161
          3333613738323038353030663130356365646564396135360a363133313234633662386539636339
          31633739346532633634663439306666366430613232386138636666613364303539363538616164
          3537633236333663340a646261303839383862613065373930643065653238333437346432323635
          36386138653962373432353364343762653931363661356537323139343561303365

    - name: Create rag api container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-rag-api"
        image: ghcr.io/danny-avila/librechat-rag-api-dev-lite:v0.5.0
        env:
          DB_HOST: "{{ _postgres_hostname }}"
          DB_PORT: "{{ _postgres_port | string }}"
          POSTGRES_DB: "{{ _postgres_database }}"
          POSTGRES_USER: "{{ _postgres_username }}"
          POSTGRES_PASSWORD: "{{ _postgres_password }}"
          RAG_OPENAI_API_KEY: "{{ openai_api_key }}"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: ghcr.io/danny-avila/librechat:v0.7.9
        user: "{{ common_user_id }}:{{ common_group_id }}"
        env:
          HOST: "0.0.0.0"

          MONGO_URI: "{{ _mongo_url }}"

          DOMAIN_CLIENT: "https://{{ application }}.{{ common_tld }}"
          DOMAIN_SERVER: "https://{{ application }}.{{ common_tld }}"

          DEBUG_LOGGING: "false"

          UID: "{{ common_user_id | string }}"
          GID: "{{ common_group_id | string }}"

          OPENAI_API_KEY: "{{ openai_api_key }}"
          # GPT-4.1: more input tokens and precise text work
          # o4-mini: reasoning, better for math, coding and visual tasks
          OPENAI_MODELS: |
            {{
              [
                "gpt-4.1-mini",
                "o4-mini",
              ] | join(",")
            }}

          IMAGE_GEN_OAI_API_KEY: "{{ openai_api_key }}"

          DEBUG_PLUGINS: "false"

          CREDS_KEY: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            39306263646231626635353433396532333734646634396333373564363863623566613732303038
            6539633462663861356431643766356164386434663262660a643365623637386230616535326261
            63646330306230366336636639616139663936363364336530643139663736373938626264656334
            3633356334656635380a343539333564656661326337316237343066613166306562613066303766
            32663562373137316335323239643030303734373061383562323766616232626431303337383138
            61393633373863653738616135366663316133306132363735626237396162363732623638646561
            31383031623962626266653564383965613030323432383761666537633039643431656436633834
            31373165616166623835
          CREDS_IV: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            66656463666532343662316539393461633738633539373262316633636636323262613334343436
            6261646330373134636430353834343465383137366165610a343533313230333234356264396338
            37633863636461333266383461363831333331626262626131633439366439363830363333636131
            3065646366653561360a613631383039316632313531316239663735386337613265633632356136
            33613864303065636235313732363466666533626234623761613134373461376633646262663132
            6633666165613232323032303531333530616561656235346461
          JWT_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            38373462643362633730626661366164363531306435353534346364363565646134306362613763
            3232373965343438363335376336363139646132376233310a653332373465383433616634656138
            64383965626132353236626632653239616163366365343662393333633164646632636565363466
            3034353731353564380a363539623831366137376439343037373037633364663335633133336231
            35386335343064376664613531356663376563343636313731633332313061616665623432666262
            39663431343931323362383265383263333061303764383734346363633761363161336262366532
            65626230363536666130376135313230336463653338613864356366333332303137323864376266
            65323661303162393837
          JWT_REFRESH_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            35353763333836393565326237363738326139383737646165396439393132303132303162396265
            6338303134343963326134326231623235636230373330640a393538373235613132646130303539
            35373666343263313834383166653366343237343161353635363265333838646530643433353566
            3130303431313564380a303239356532666532376666396566663732653938333863656465333237
            35343934316665623233366237353836633765363532353733353334373430303963663837323339
            30376163343236313537313730626434393464613463326165346665396665616266643834653365
            64353937623261373138363238313132626461653361613036316230613666383332343939356237
            66356230633539323461

          SEARCH: "true"
          MEILI_HOST: "{{ _meilisearch_url }}"
          MEILI_MASTER_KEY: "{{ _meilisearch_password }}"

          RAG_API_URL: "http://{{ application }}-rag-api:8000"

          ALLOW_EMAIL_LOGIN: "false"
          ALLOW_REGISTRATION: "false"
          ALLOW_SOCIAL_LOGIN: "true"
          ALLOW_SOCIAL_REGISTRATION: "true"

          OPENID_CLIENT_ID: "{{ application }}"
          OPENID_CLIENT_SECRET: "{{ oidc_auth.librechat.secret }}"
          OPENID_ISSUER: "{{ oidc_discovery_url }}"
          OPENID_SESSION_SECRET: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            39386332313830366666363662623930666164636162643335336432636663636635393539646561
            6566636632623539343831313938663633316232663261360a383262633830643962666565346237
            63363463356565616237656134656663373365323234383666626537396430386534343837333065
            3832333866626562340a626561333565636239623939643765396338613938303739316162613162
            62336235376430313662396331393335383338663363376265616437373031633131
          OPENID_SCOPE: "openid profile email"
          OPENID_CALLBACK_URL: /oauth/openid/callback
          OPENID_USERNAME_CLAIM: preferred_username
          OPENID_NAME_CLAIM: name
          OPENID_BUTTON_LABEL: "Log in with {{ oidc_provider | title }}"
          OPENID_IMAGE_URL: "https://minio.{{ common_tld }}/public/authelia-logo-cropped.png"
          OPENID_AUTO_REDIRECT: "false"
        volumes:
          - "{{ config_directory }}/images:/app/client/public/images"
          - "{{ config_directory }}/uploads:/app/uploads"
          - "{{ config_directory }}/logs:/app/api/logs"
        traefik:
          - port: 3080
        homepage:
          name: LibreChat
          group: Tools
          weight: 150
          description: "AI Chat"
