---

- hosts: homelab

  vars:
    application: changedetection

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create webdriver container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-webdriver"
        image: selenium/standalone-chrome-debug:3.141.59
        volumes:
          - /dev/shm:/dev/shm
        comparisons:
          env: strict

    - name: Create "{{ application }}" container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: ghcr.io/dgtlmoon/changedetection.io:0.40.0.3
        volumes:
          - "{{ config_directory }}:/datastore"
        env:
          BASE_URL: "https://{{ application }}.{{ common_tld }}"

          WEBDRIVER_URL: "http://{{ application }}-webdriver:4444/wd/hub"

          webdriver_httpProxy: "10.8.0.1:1080"
          webdriver_ftpProxy: "10.8.0.1:1080"
          webdriver_sslProxy: "10.8.0.1:1080"
          webdriver_proxyType: "MANUAL"
          webdriver_socksProxy: "10.8.0.1:1080"
          webdriver_socksVersion: "5"

          PUID: "{{ common_user_id | string }}"
          PGID: "{{ common_group_id | string }}"
        traefik:
          - port: 5000
        homer:
          name: Change Detection
          service: Tools
          priority: 690
          subtitle: "Website change detection"
        comparisons:
          env: strict
