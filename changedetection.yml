---

- hosts: homelab

  vars:
    application: changedetection

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create playwright container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-playwright-chrome"
        image: browserless/chrome:1.57-chrome-stable
        shm_size: "2g"
        env:
          DEFAULT_LAUNCH_ARGS: '["--window-size=1920,1080"]'

    - name: Create "{{ application }}" container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: ghcr.io/dgtlmoon/changedetection.io:0.40.2
        volumes:
          - "{{ config_directory }}:/datastore"
        env:
          BASE_URL: "https://{{ application }}.{{ common_tld }}"

          PLAYWRIGHT_DRIVER_URL: "ws://{{ application }}-playwright-chrome:3000/?stealth=1&--disable-web-security=true"

          PUID: "{{ common_user_id | string }}"
          PGID: "{{ common_group_id | string }}"
        traefik:
          - port: 5000
        homer:
          name: Change Detection
          service: Tools
          priority: 690
          subtitle: "Website change detection"
        comparisons:
          env: strict
