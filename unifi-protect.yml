---

- hosts: homelab

  tasks:
    - name: Grab public SSH key to add to NVR host
      ansible.builtin.slurp:
        src: /root/.ssh/id_ed25519.pub
      register: __homelab_public_key

- hosts: nvr

  handlers:
    - name: Restart nut
      ansible.builtin.service:
        name: nut-monitor
        state: restarted
        enabled: true

  tasks:
    - name: Set authorized keys
      ansible.posix.authorized_key:
        user: root
        state: present
        key: "{{ item }}"
      loop:
        - https://github.com/calvinbui.keys
        - "{{ hostvars['homelab.' + common_local_tld]['__homelab_public_key']['content'] | b64decode }}"

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Install nut
      ansible.builtin.apt:
        name: nut-client
        state: present
      register: result
      until: result is success
      retries: 5
      delay: 5

    - name: Configure nut
      notify: Restart nut
      block:
        - name: Set nut mode
          ansible.builtin.lineinfile:
            path: "/etc/nut/{{ item.file }}.conf"
            regex: "{{ item.regex }}"
            line: "{{ item.line }}"
          loop:
            - file: nut
              regex: "^MODE="
              line: "MODE={{ nut_mode }}"

        - name: Configure nut
          ansible.builtin.blockinfile:
            path: "/etc/nut/{{ item.file }}.conf"
            marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item.name }}"
            block: "{{ item.block }}"
          loop:
            - file: upsmon
              name: monitors
              block: "{{ nut_ups_monitors | string }}"
