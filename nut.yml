---

- hosts: homelab

  vars:
    application: nut

    # variables are in group_vars. override as needed
    nut_host: localhost

    nut_mode: netserver

    nut_user_mode: "master"

    nut_max_retry: 3

    nut_ups_devices:
      - |
        [cyberpower]
          driver = usbhid-ups
          port = auto
          ignorelb
          pollinterval = 15
          override.battery.charge.low = 20
          override.battery.charge.warning = 40
          override.battery.runtime.low = 300
          override.ups.delay.start = 120
          override.ups.delay.shutdown = 120

    nut_ups_listen: |
      LISTEN 127.0.0.1 3493
      LISTEN {{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }} 3493
      LISTEN ::1 3493

  handlers:
    - name: Restart
      ansible.builtin.service:
        name: "{{ item }}"
        state: restarted
        enabled: true
      with_items:
        - nut-driver
        - nut-monitor
        - nut-server

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Install
      ansible.builtin.apt:
        name: nut
        state: present
        update_cache: true
        cache_valid_time: 3600
      register: result
      until: result is success
      retries: 5
      delay: 5

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Install NUT configuration files.
      ansible.builtin.template:
        src: "{{ files_directory }}/{{ item }}.j2"
        dest: "/etc/nut/{{ item }}"
        owner: root
        group: nut
        mode: "0655"
      loop:
        - email-notification.sh
        - ups.conf
        - upsd.conf
        - upsd.users
        - upsmon.conf
        - nut.conf
      notify: Restart
