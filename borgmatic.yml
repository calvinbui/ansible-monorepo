---
# https://torsion.org/borgmatic/

# Init the backup with
# docker exec borgmatic sh -c "borgmatic --init --encryption repokey-blake2"

# Extract the encryption key with
# borg key export /mnt/destination

# Start a backup with
# borgmatic --stats

# Restore a backup with
# borgmatic extract

- hosts: homelab
  become: true
  vars:
    network: "{{ networks.mgmt }}"
    borgmatic_common_directory: "/borgmatic"
    borgmatic_repository_directory: "{{ borgmatic_common_directory }}/borgbackup" # borg backup repo
    borgmatic_pass: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      37626530363533323433633066656632393664313962366264363435386635346634613433303661
      3866616565383433353636356337356438373934373433650a653235663033383330386638303031
      63303930626431656232343336393965343966653330323964313532353964613030643137616363
      3966623038626139300a666265326566373439663038393432396432356636353733643361623031
      35663138313039623361346562346234636365316164636365663439326663643261643438376334
      3361306465303461613739396564306434333033643962616664
    borgmatic_notification_webhook: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      35316463616432373433336236326164616232316162646138373738656634353466653863613563
      3135313633663131386434363036363936653763366661370a343064653032623133303638656566
      38373633306665333363666331633339666634653737376530386263373539636262653839386238
      6264623635633564640a643531386632323565616138376261383563353861646634646433333534
      65363932316661303164623130656234323234323962323263636338303539643431363531343435
      37386565336366383061353634643261616163666361656466343036386137363062336236343933
      38386630306635626434366464386234343265333230303965303239323366386565336130306639
      65633139313433323530
  module_defaults:
    docker_container:
      image: b3vis/borgmatic
      keep_volumes: false
      state: started
      restart_policy: unless-stopped
      networks_cli_compatible: true
      purge_networks: true
      env:
        TZ: "{{ common_timezone }}"
        BORG_PASSPHRASE: "{{ borgmatic_pass }}"
      networks:
        - name: "{{ network.name }}"
      dns_servers: "{{ network.dns }}"
      comparisons:
        env: strict
        labels: allow_more_present
      labels:
        traefik.enable: "false"
      container_default_behavior: no_defaults
      network_mode: "{{ network.name }}"

  pre_tasks:
    - name: Create Borgmatic directories
      file:
        path: "{{ borgmatic_common_directory }}"
        state: directory

    - name: Clone Borgbackup repo
      git:
        repo: https://github.com/borgbackup/borg
        clone: true
        dest: "{{ borgmatic_repository_directory }}"
        version: "1.1.15"

  roles:
    - role: borgmatic
      vars:
        borgmatic_name: misc
        borgmatic_source: "{{ common_directory_misc }}"
        borgmatic_crontab: "0 2 * * *"
        borgmatic_ssh_src: files/borgmatic/ssh/
        borgmatic_config: "borgmatic/{{ borgmatic_name }}.yaml.j2"
      tags:
        - misc
    - role: borgmatic
      vars:
        borgmatic_name: work
        borgmatic_source: "{{ common_directory_storage }}/Work"
        borgmatic_crontab: "30 2 * * *"
        borgmatic_ssh_src: files/borgmatic/ssh/
        borgmatic_config: "borgmatic/{{ borgmatic_name }}.yaml.j2"
      tags:
        - work
    - role: borgmatic
      vars:
        borgmatic_name: apps
        borgmatic_source: "{{ common_directory }}"
        borgmatic_crontab: "0 3 * * *"
        borgmatic_ssh_src: files/borgmatic/ssh/
        borgmatic_config: "borgmatic/{{ borgmatic_name }}.yaml.j2"
      tags:
        - apps
    - role: borgmatic
      vars:
        borgmatic_name: photos
        borgmatic_source: "{{ common_directory_photos }}"
        borgmatic_crontab: "30 3 * * *"
        borgmatic_ssh_src: files/borgmatic/ssh/
        borgmatic_config: "borgmatic/{{ borgmatic_name }}.yaml.j2"
      tags:
        - photos