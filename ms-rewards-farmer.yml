---

- hosts: homelab

  vars:
    application: ms-rewards-farmer

    ms_rewards_farmer_accounts:
      - email: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          61623636346636373165623964653033343464323132323166363366613764633035363936643935
          3666363434326561306433306238373235393739663636380a303137303634353730333937626564
          65396533613234323364383630313463636338333335366462613966396636313431303334633837
          3534343964336437660a383734316365623936363531396664323162396535623630313364376661
          33626330663165313335623332613835663831356436656163613536373230383065
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          30343032346665386133353861386634613364396566363739666337396638353064316238623936
          6632333961383932653433366164336239316434613463330a363964613163613563376561323662
          32313834666636386431613035383639396231363536353334393163653363343536646138393735
          3030306263373131620a643935363039383932326634323462356336343065616463303436636439
          62653761653435643737613130363430333763363763373938663730313839353434
        totp: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          61323638383136363739393639623130653034353934616135343939343031373031656462626538
          3836313630666662336661333266333764646461363766320a613164616332323331653139396335
          66356633653832306533343835383765396438303439643766333166633861366462333631613262
          6261313765366139380a373938663163653637613430363039343131656166313036306532633762
          64303337386465616362656631336233613766383332396165333064373462356535
      - email: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66616231626130343737356135373961333063616465643762643333356131656461383734383330
          3034656139356164613830626236366464663663663735640a343031323965313131616162303735
          64616131633337343033623864303662386565366664626238383732633038643737613430326265
          6135613039363334640a316439646566376661653165336261353361663333666533323738663863
          34623635656666346432643234613230373632326539346333623534323362376530
        password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32613639376165373330356464373232623365343264343065386565313733316131313130323132
          3566626363633431643531376237326633653763336334380a623333336439393035383066633132
          39653930383535303366653436353431663935653434373766643638656262376163633338306566
          3531623232643265340a353863386436333366333033623236343138373461653761623862633434
          34363735373237656138653064663737313635353661303766323831366135353230
        totp: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          38623933303464383230623737396462326436343934633530333630623935396262656163643666
          6262363039353638623935383863623562373562346164620a336136663739386362363263653866
          66663466386363646532363366633933313166366162363933383931306533343763346539616633
          6466386135343161630a306239303361656532393132303937323162663062306662396332663638
          64386233333038396335383937383533373466386261313434376161383832356634

    docker_network: "{{ networks.user }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Clone
      ansible.builtin.git:
        repo: "https://github.com/klept0/MS-Rewards-Farmer.git"
        version: develop
        dest: "{{ config_directory }}/repo"
        update: true
      register: _ms_rewards_farmer_repo_updated

    - name: Build image
      community.docker.docker_image:
        name: "{{ application }}"
        build:
          path: "{{ config_directory }}/repo"
          dockerfile: Dockerfile
          pull: true
        source: build
        state: present
        force_source: "{{ true if _ms_rewards_farmer_repo_updated.changed else false }}"

    - name: Generate config
      ansible.builtin.template:
        src: "{{ files_directory }}/config.yaml.j2"
        dest: "{{ config_directory }}/config.yaml"
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0440"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: "{{ application }}"
        env:
          RUN_ONCE: "false"
          CRON_SCHEDULE: "40 0 * * *"
        volumes:
          - /etc/localtime:/etc/localtime:ro
          - "{{ config_directory }}/config.yaml:/app/config.yaml:ro"
          - "{{ config_directory }}/sessions:/app/sessions"
        labels:
          com.centurylinklabs.watchtower.enable: "false"
