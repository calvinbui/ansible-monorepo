---
- hosts: homelab
  become: true
  vars:
    network: "{{ networks.user }}"
    piwigo_name: piwigo
    piwigo_image: linuxserver/piwigo
    piwigo_volumes:
      - "{{ common_directory }}/piwigo/piwigo:/config"
      - "{{ common_directory_photos }}:/photos"
    piwigo_environment_variables:
      PUID: "{{ common_user_id }}"
      PGID: "{{ common_group_id }}"
      TZ: "{{ common_timezone }}"

    piwigo_docker_additional_options:
      labels:
        traefik.http.routers.piwigo.entrypoints: "web"
        traefik.http.routers.piwigo.middlewares: "redirect@file"

        traefik.http.routers.piwigo-secure.entrypoints: "web-secure"
        traefik.http.routers.piwigo-secure.tls: "true"
        traefik.http.routers.piwigo-secure.tls.certresolver: letsencrypt

        traefik.http.services.piwigo.loadbalancer.server.port: "80"

        com.datadoghq.ad.check_names: '["http_check"]'
        com.datadoghq.ad.init_configs: '[{}]'
        com.datadoghq.ad.instances: '[{"name":"{{ piwigo_name }}","url":"https://{{ piwigo_name }}.{{ common_tld | string }}"}]'
    apt_install_packages:
      - name:
          - libwww-perl
          - libjson-perl
        state: present
    mariadb_name: piwigo-mariadb
    mariadb_version: '10'
    mariadb_directory: "{{ common_directory }}/piwigo/mariadb"
    mariadb_environment_variables:
      MYSQL_ROOT_PASSWORD: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        38333935656237633964633337633365313737356163623761343138323330633766363236363863
        3530666264353766646336393162306634366234636139650a376561386137366161363461353935
        37346434306661343632616436336533643530366336353739343633636163646632336336326462
        3933373064396335610a613035616235383566326264336661656264303330333563316464383538
        3537
      MYSQL_DATABASE: piwigo
  module_defaults:
    docker_container:
      keep_volumes: false
      restart_policy: unless-stopped
      networks_cli_compatible: true
      purge_networks: true
      dns_servers: "{{ network.dns }}"
      networks:
        - name: "{{ network.name }}"
  pre_tasks:
    - name: Update apt cache
      apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false
  roles:
    - role: apt
      when: ansible_os_family == 'Debian'
    - mariadb
    - piwigo
  post_tasks:
    - name: Symlink Photos folder to Piwigo's Galleries (paths are within container)
      file:
        src: "/photos"
        dest: "{{ common_directory }}/piwigo/piwigo/www/gallery/photos"
        state: link
        force: true
    - name: Copy Quick Sync plugin (https://br.piwigo.org/ext/extension_view.php?eid=855)
      copy:
        src: files/piwigo/piwigo_refresh.pl
        dest: "{{ common_directory }}/piwigo/piwigo_refresh.pl"
    - name: Create cronjob for Quick Sync
      cron:
        name: "Sync Gallery"
        special_time: "hourly"
        job: "perl {{ common_directory }}/piwigo/piwigo_refresh.pl --base_url=http://piwigo.{{ common_local_tld }} --user={{ common_user }} --password={{ mariadb_environment_variables.MYSQL_ROOT_PASSWORD }} --directory='./photos/'"
        state: present
