---

- name: Create MongoDB directories
  ansible.builtin.file:
    path: "{{ mongo_directory }}/{{ item }}"
    state: directory
    owner: 999
    group: 999
    mode: "0700"
  loop:
    - dump
    - db

- name: Create MongoDB container
  ansible.builtin.include_role:
    name: podman_container
  vars:
    container_name: "{{ mongo_name }}"
    image: "public.ecr.aws/docker/library/mongo:{{ mongo_version }}"

    command: "{{ mongo_command | ansible.builtin.default(omit) }}"

    env:
      MONGO_INITDB_ROOT_USERNAME: "{{ mongo_username }}"
      MONGO_INITDB_ROOT_PASSWORD: "{{ mongo_password }}"
      MONGO_INITDB_DATABASE: "{{ mongo_database }}"
      TZ: "{{ common_timezone }}"

    volumes:
      - "{{ mongo_directory }}/db:/data/db"
      - "{{ mongo_directory }}/dump:/dump"
      - /etc/localtime:/etc/localtime:ro

    labels:
      - traefik.enable=false

- name: Set variables
  ansible.builtin.set_fact:
    _mongo_hostname: "{{ mongo_name }}"
    _mongo_username: "{{ mongo_username }}"
    _mongo_password: "{{ mongo_password }}"
    _mongo_database: "{{ mongo_database }}"
    _mongo_port: 27017

- name: Set connection URL variable
  ansible.builtin.set_fact:
    _mongo_url: "mongodb://{{ _mongo_username }}:{{ _mongo_password }}@{{ _mongo_hostname }}:{{ _mongo_port }}/{{ _mongo_database }}?authSource=admin"
