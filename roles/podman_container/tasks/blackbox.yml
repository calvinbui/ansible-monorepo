---

- name: "Generating HTTP blackbox service discovery labels"
  when: route.type is undefined or (route.type is defined and route.type == "http")
  ansible.builtin.set_fact:
    blackbox_labels: "{{ blackbox_labels | ansible.builtin.default({}) | ansible.builtin.combine({item.key: item.value}) }}"
  loop:
    -
      key: "blackbox.enable"
      value: "true"
    -
      key: "blackbox.auth"
      value: "{{ blackbox.auth | ansible.builtin.default(route.auth) | ansible.builtin.default('none') }}"
    -
      key: "blackbox.target"
      value: "{{ blackbox.protocol|default('https') }}://{{ (route.rule | ansible.builtin.regex_replace('^Host\\(`(.*?)`\\).*$', '\\1')) if route.rule is defined else (blackbox.host | ansible.builtin.default(route_name + '.' + common_tld)) }}{{ blackbox.path | ansible.builtin.default('') }}"

- name: "Generating TCP blackbox service discovery labels"
  when: route.type is defined and route.type == "tcp"
  ansible.builtin.set_fact:
    blackbox_labels: "{{ blackbox_labels | ansible.builtin.default({}) | ansible.builtin.combine({item.key: item.value}) }}"
  loop:
    -
      key: "blackbox.enable"
      value: "true"
    -
      key: "blackbox.probe"
      value: "tcp"
    -
      key: "blackbox.target"
      value: "{{ common_tld }}:{{ route.port }}"
