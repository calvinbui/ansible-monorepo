---

- name: Create Elasticsearch directory
  ansible.builtin.file:
    path: "{{ elasticsearch_directory }}"
    state: directory
    owner: "1000" # elasticsearch
    group: "1000" # elasticsearch
    mode: "0740"

- name: Create Elasticsearch container
  ansible.builtin.include_role:
    name: podman_container
  vars:
    container_name: "{{ elasticsearch_name }}"
    image: "docker.elastic.co/elasticsearch/elasticsearch:{{ elasticsearch_version }}"

    command: "{{ elasticsearch_command | ansible.builtin.default(omit) }}"

    memory: "{{ elasticsearch_memory | ansible.builtin.default('1G') }}"

    env: "{{
        {
          'ELASTIC_PASSWORD': elasticsearch_password,
          'ES_SETTING_CLUSTER_NAME': elasticsearch_name,
          'ES_SETTING_DISCOVERY_TYPE': 'single-node',
          'ES_SETTING_XPACK_SECURITY_ENABLED': 'false',
          'ES_SETTING_BOOTSTRAP_MEMORY__LOCK': 'true',
          'ES_SETTING_LOGGER_ORG_ELASTICSEARCH': 'WARN'
        } | ansible.builtin.combine(elasticsearch_environment)
      }}"

    volumes:
      - "{{ elasticsearch_directory }}:/usr/share/elasticsearch/data"

    cap_add:
      - IPC_LOCK

    labels:
      - traefik.enable=false

- name: Set variables
  ansible.builtin.set_fact:
    _elasticsearch_hostname: "{{ elasticsearch_name }}"
    _elasticsearch_password: "{{ elasticsearch_password }}"
    _elasticsearch_port: 9200

- name: Set connection URL variable
  ansible.builtin.set_fact:
    _elasticsearch_url: "http://elastic:{{ _elasticsearch_password }}@{{ _elasticsearch_hostname }}:{{ _elasticsearch_port }}"
