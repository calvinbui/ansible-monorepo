---

- name: Create Meilisearch directory
  ansible.builtin.file:
    path: "{{ meilisearch_directory }}"
    state: directory
    owner: 1000
    group: 0
    mode: "0771"

- name: Create Meilisearch container
  ansible.builtin.include_role:
    name: podman_container
  vars:
    container_name: "{{ meilisearch_name }}"
    image: "docker.io/getmeili/meilisearch:v{{ meilisearch_version }}"

    command:
      - /bin/meilisearch
      - --experimental-dumpless-upgrade

    env:
      MEILI_NO_ANALYTICS: "true"
      MEILI_MASTER_KEY: "{{ meilisearch_password }}"

    volumes: "{{ meilisearch_directory }}:/meili_data"

    labels:
      - traefik.enable=false

- name: Set variables
  ansible.builtin.set_fact:
    _meilisearch_hostname: "{{ meilisearch_name }}"
    _meilisearch_port: "7700"
    _meilisearch_password: "{{ meilisearch_password }}"

- name: Set connection URL variable
  ansible.builtin.set_fact:
    _meilisearch_url: "http://{{ _meilisearch_hostname }}:{{ _meilisearch_port }}"
