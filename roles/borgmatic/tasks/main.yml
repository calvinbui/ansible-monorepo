---

- name: "Create Borgmatic {{ borgmatic_name }} directories"
  file:
    path: "{{ item }}"
    state: directory
    mode: "0744"
  loop:
    - "{{ borgmatic_folder }}/borgmatic.d"
    - "{{ borgmatic_folder }}/config"
    - "{{ borgmatic_folder }}/ssh"
    - "{{ borgmatic_folder }}/cache"

- name: "Template Borgmatic {{ borgmatic_name }} configuration"
  template:
    src: "{{ borgmatic_config }}"
    dest: "{{ borgmatic_folder }}/borgmatic.d/config.yaml"
    owner: root
    group: root
    mode: "0744"
  notify: Restart Borgmatic

- name: "Template Borgmatic {{ borgmatic_name }} crontab"
  template:
    src: borgmatic/crontab.txt.j2
    dest: "{{ borgmatic_folder }}/borgmatic.d/crontab.txt"
    owner: root
    group: root
    mode: "0744"
  notify: Restart Borgmatic

- name: Copy SSH keys
  copy:
    src: "{{ borgmatic_ssh_src }}"
    dest: "{{ borgmatic_folder }}/ssh/"
    owner: root
    group: root
    mode: '0600'
  notify: Restart Borgmatic

- name: Template notification script
  template:
    src: borgmatic/notifications.sh.j2
    dest: "{{ borgmatic_folder }}/borgmatic.d/notifications.sh"
    mode: '0500'
  notify: Restart Borgmatic

- name: Create Borgmatic {{ borgmatic_name }} container
  docker_container:
    name: "borgmatic-{{ borgmatic_name }}"
    hostname: "borgmatic-{{ borgmatic_name }}"
    volumes:
      # data to backup. dont mount as ro when a restore is needed
      - "{{ borgmatic_source }}:/mnt/source:ro"

      - "{{ borgmatic_repository_directory }}:/mnt/borg-repository"

      - "{{ borgmatic_folder }}/borgmatic.d/:/etc/borgmatic.d/"
      - "{{ borgmatic_folder }}/borgmatic:/root/.borgmatic"
      - "{{ borgmatic_folder }}/config/borg:/root/.config/borg"
      - "{{ borgmatic_folder }}/ssh:/root/.ssh"
      - "{{ borgmatic_folder }}/cache/borg:/root/.cache/borg"
