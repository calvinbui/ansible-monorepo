---

- hosts: homelab

  vars:
    application: blackbox_exporter

    blackbox_auth_username: "{{ application }}"
    blackbox_auth_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      33383539396530616664656239396337353830663534336439616236386162366333666535666631
      6666356464306265373734306432326337376531313833650a643837393939666433316261303464
      61323839363339326237623966353166313038313735343966626638633239633665623934366436
      6334343065333961650a336634616237333431366565386461623538396266653764323332656131
      61303761636338323135346661353164303032653865663635643730633431376664313033333834
      3032663738383236336361346232393162636430316363633264

    docker_network: "{{ networks.mgmt }}"

  handlers:
    - name: Restart
      ansible.builtin.command: docker restart "{{ application }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0711"
      register: _config_dir

    - name: Template configuration
      ansible.builtin.template:
        src: "{{ files_directory }}/config.yml.j2"
        dest: "{{ _config_dir.path }}/config.yml"
        mode: "0440"
        validate: "docker run --rm --name {{ application }}_config_check -v %s:/tmp/config.yml prom/blackbox-exporter:master --config.check --config.file=/tmp/config.yml"
      notify: Restart

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: prom/blackbox-exporter:master
        volumes:
          - "{{ _config_dir.path }}:/etc/blackbox_exporter"
