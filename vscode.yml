---

- hosts: homeserver

  vars:
    application: vscode

    container_network: "{{ networks.pub }}"

  handlers:
    - name: Restart
      containers.podman.podman_container:
        name: "{{ application }}"
        force_restart: true

  tasks:
    - name: Create config folders
      ansible.builtin.file:
        path: "{{ config_directory }}/{{ item }}"
        state: directory
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0771"
      loop:
        - local
        - config

    - name: Create container
      ansible.builtin.include_role:
        name: podman_container
      vars:
        image: ghcr.io/coder/code-server:4.105.1
        user: "{{ common_root_id | ansible.builtin.string }}:{{ common_root_group | ansible.builtin.string }}"
        env:
          PASSWORD: &vscode_password !vault |
            $ANSIBLE_VAULT;1.1;AES256
            66333461326163353033646637636638383934633433613039323939303133333134396638336538
            3830666433616139656637656661343136643736316536310a386630626332386465633263343138
            35323566303038303862313862336434633531363462343962353261393830353931623239623939
            3530323432323535390a376135623232653165323762313933323464666232363736353766636536
            64393833313232623936626662363130313137623465626661373830613938663661

          CS_DISABLE_GETTING_STARTED_OVERRIDE: "true"
        volumes:
          - "{{ config_directory }}/local:/root/.local"
          - "{{ config_directory }}/config:/root/.config"
          - "{{ common_directory }}/home-assistant/config/:/root/project"
        traefik:
          - port: 8080
        homepage:
          name: VS Code
          group: Programming
          weight: 300
          description: "VS Code in the browser"
        blackbox:
          path: /healthz

    # follows https://github.com/hassio-addons/addon-vscode/blob/main/vscode/Dockerfile
    - name: Install Home Assistant extensions
      block:
        - name: Create download directory
          ansible.builtin.file:
            path: "{{ config_directory }}/local/share/code-server/CachedExtensionVSIXs"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0755"

        - name: Download vscode.extensions file
          ansible.builtin.get_url:
            url: https://raw.githubusercontent.com/hassio-addons/addon-vscode/master/vscode/vscode.extensions
            dest: "{{ config_directory }}/local/share/code-server/vscode.extensions"
            mode: "0644"

        - name: Read extension list
          ansible.builtin.slurp:
            src: "{{ config_directory }}/local/share/code-server/vscode.extensions"
          register: vscode_extensions_file

        - name: Set extension list fact
          ansible.builtin.set_fact:
            home_assistant_vscode_extensions: "{{ vscode_extensions_file.content | b64decode | split('\n') | select() }}"

        - name: Download extensions
          ansible.builtin.get_url:
            url: "https://marketplace.visualstudio.com/_apis/public/gallery/publishers/{{ item.split('.')[0] }}/vsextensions/{{ item.split('.')[1].split('#')[0] }}/{{ item.split('#')[1] }}/vspackage"
            dest: "{{ config_directory }}/local/share/code-server/CachedExtensionVSIXs/{{ item.split('#')[0] }}-{{ item.split('#')[1] }}.vsix"
            mode: "0640"
            http_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.130 Safari/537.36"
            headers:
              x-market-user-id: "{{ 1000 | ansible.builtin.random | ansible.builtin.to_uuid }}"
          loop: "{{ home_assistant_vscode_extensions }}"
          register: result
          until: result is success
          retries: 5
          delay: 5

        - name: Install extensions
          containers.podman.podman_container_exec:
            name: "{{ application }}"
            user: "{{ common_root_id }}"
            command: code-server --install-extension /root/.local/share/code-server/CachedExtensionVSIXs/{{ item.split('#')[0] }}-{{ item.split('#')[1] }}.vsix
          loop: "{{ home_assistant_vscode_extensions }}"
          register: _command_result
          failed_when: "'was successfully installed.' not in _command_result.stdout"
          changed_when: false # output is always the same
