---

- hosts: homelab

  vars:
    application: stable-diffusion

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: emsi/stable-diffusion-webui:latest
        command: python3 launch.py --listen
        env:
          NVIDIA_VISIBLE_DEVICES=all
        volumes:
          - "{{ config_directory }}/repo/embeddings:/stable-diffusion-webui/embeddings"
          - "{{ config_directory }}/repo/extensions:/stable-diffusion-webui/extensions"
          - "{{ config_directory }}/repo/interrogate:/stable-diffusion-webui/interrogate"
          - "{{ config_directory }}/repo/models:/stable-diffusion-webui/models"
          - "{{ config_directory }}/repo/outputs:/stable-diffusion-webui/outputs"
          - "{{ config_directory }}/repo/repositories:/stable-diffusion-webui/repositories"
          - "{{ config_directory }}/cache:/root"
        device_requests:
          - driver: nvidia
            count: -1
            device_ids: []
            options: {}
            capabilities:
              - - gpu
                - video
                - compute
                - utility
        traefik:
          - port: 7860
            auth: page
