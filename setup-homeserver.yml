---

# install openssh-server and python3 first: `$ sudo apt install openssh-server python3`
# reboot afterwards as dbus will also be installed on a minimal system: `$ sudo reboot`
# execute this playbook the first time: `$ ansible-playbook setup-bootstrap.yml -k -K`

- hosts: homeserver

  handlers:
    - name: Reload sysctl
      ansible.builtin.command:
        cmd: /sbin/sysctl --system
      changed_when: true

    - name: Reboot
      ansible.builtin.reboot:
        reboot_timeout: 360

    - name: Reload systemd
      ansible.builtin.systemd_service:
        daemon_reexec: true

  tasks:
    - name: No password sudo
      community.general.sudoers:
        name: "{{ common_user }}"
        user: "{{ common_user }}"
        commands: ALL
        nopassword: true

    - name: Disable password expiration
      ansible.builtin.user:
        name: "{{ common_user }}"
        password_expire_max: -1

    - name: Install python3-debian
      ansible.builtin.apt:
        name: python3-debian
        state: present
        update_cache: true
        cache_valid_time: 86400

    - name: Install apt packages
      ansible.builtin.apt:
        name:
          - curl
          - git
          - htop
          - jq
          - neovim
          - nvme-cli
          - rclone
          - tmux
          - python3-lxml
          - python3-passlib
          - python3-yaml
          - ripgrep
          - unzip
        state: present
        update_cache: true
        cache_valid_time: 86400

    - name: Enable additional Debian repositories
      ansible.builtin.deb822_repository:
        name: "{{ item.name }}"
        uris: http://deb.debian.org/debian
        suites: "{{ item.suites }}"
        components: "{{ item.components }}"
        signed_by: /usr/share/keyrings/debian-archive-keyring.gpg
      loop:
        -
          name: debian-contrib
          suites: "{{ ansible_distribution_release }}"
          components:
            - contrib
        -
          name: debian-non-free
          suites: "{{ ansible_distribution_release }}"
          components:
            - non-free
        -
          name: debian-sid
          suites: sid
          components:
            - main

    - name: Set sid repository priority
      ansible.builtin.copy:
        dest: /etc/apt/preferences.d/sid
        content: |
          Package: *
          Pin: release n=sid
          Pin-Priority: -10
        owner: root
        group: root
        mode: "0644"

    - name: Generate SSH keypairs
      community.crypto.openssh_keypair:
        path: "/home/{{ common_user }}/.ssh/id_ed25519"
        type: ed25519
      become: false
      become_user: "{{ common_user }}"

    - name: Set authorized keys from GitHub
      ansible.posix.authorized_key:
        user: "{{ common_user }}"
        state: present
        key: https://github.com/calvinbui.keys
        comment: github

    - name: Set hostname
      ansible.builtin.hostname:
        name: "homeserver.{{ common_local_tld }}"

    - name: Set timezone
      community.general.timezone:
        name: "{{ common_timezone }}"

    - name: Create common directory
      ansible.builtin.file:
        path: "{{ common_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Update sysctls
      ansible.posix.sysctl:
        name: "{{ item.key }}"
        value: "{{ item.value }}"
        sysctl_file: /etc/sysctl.d/99-tuning.conf
        reload: false
      loop: "{{ sysctl_settings | ansible.builtin.dict2items }}"
      notify: Reload sysctl
      vars:
        sysctl_settings:
          # file limits/inotify
          fs.file-max: 2097152
          fs.inotify.max_user_watches: 1048576
          fs.inotify.max_user_instances: 8192

          # memory management
          vm.dirty_background_bytes: 4294967296 # 4GB
          vm.dirty_bytes: 8589934592 # 8GB
          vm.max_map_count: 524288 # for some databases like ES, TSDB

          # kernel
          kernel.pid_max: 4194304
          kernel.threads-max: 2097152

          # networking
          net.core.somaxconn: 65536
          net.core.netdev_max_backlog: 65536
          net.ipv4.tcp_max_syn_backlog: 32768

          # tcp optimisations
          net.ipv4.tcp_congestion_control: bbr
          net.core.default_qdisc: fq
          net.ipv4.tcp_fastopen: 3
          net.ipv4.tcp_tw_reuse: 1
          net.ipv4.tcp_fin_timeout: 15
          net.ipv4.ip_local_port_range: 1024 65535
          net.ipv4.tcp_mtu_probing: 1

          ## tcp/ip buffer tuning
          net.core.rmem_max: 33554432 # 32MB
          net.core.wmem_max: 33554432 # 32MB
          net.core.rmem_default: 262144 # 256KB
          net.core.wmem_default: 262144 # 256KB
          net.ipv4.tcp_rmem: 4096 87380 33554432
          net.ipv4.tcp_wmem: 4096 65536 33554432

          # mdadm
          dev.raid.speed_limit_min: 100000
          dev.raid.speed_limit_max: 7000000

    - name: Increase pam limits
      community.general.pam_limits:
        domain: "root"
        limit_type: "{{ item.type }}"
        limit_item: "{{ item.item }}"
        value: "{{ item.value }}"
        comment: "Managed by Ansible"
        dest: "/etc/security/limits.d/99-tuning.conf"
      notify: Reboot
      loop:
        -
          type: soft
          item: nofile
          value: 65536
        -
          type: hard
          item: nofile
          value: 131072
        -
          type: soft
          item: nproc
          value: 16384
        -
          type: hard
          item: nproc
          value: 32768

    - name: Create systemd config drop-in directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
      loop:
        - /etc/systemd/system.conf.d
        - /etc/systemd/user.conf.d

    - name: Configure systemd service limits
      community.general.ini_file:
        path: "{{ item.0 }}"
        section: Manager
        option: "{{ item.1.option }}"
        value: "{{ item.1.value }}"
        mode: "0644"
        create: true
      loop: "{{ systemd_configs | ansible.builtin.product(systemd_limits) | ansible.builtin.list }}"
      notify: Reload systemd
      vars:
        systemd_configs:
          - /etc/systemd/system.conf.d/99-limits.conf
          - /etc/systemd/user.conf.d/99-limits.conf
        systemd_limits:
          -
            option: DefaultLimitNOFILE
            value: 131072
          -
            option: DefaultLimitNPROC
            value: 32768
