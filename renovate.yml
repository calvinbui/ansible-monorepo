---

- hosts: homeserver

  vars:
    application: renovate

    container_network: "{{ networks.pub }}"

  handlers:
    - name: Restart
      containers.podman.podman_container:
        name: "{{ application }}"
        force_restart: true

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: 12021
        group: "{{ common_group_id }}"
        mode: "0751"
        recurse: true

    - name: Create container
      ansible.builtin.include_role:
        name: podman_container
      vars:
        image: ghcr.io/renovatebot/renovate:41
        stop_signal: "{{ signal_map['SIGKILL'] }}"
        entrypoint: /bin/bash
        command:
          - -c
          - renovate --version > /tmp/renovate.log && /bin/tail -f /tmp/renovate.log
        volumes:
          - "{{ config_directory }}:/base"
        labels:
          - "ofelia.enabled=true"
          - "ofelia.job-exec.{{ application }}-cron.schedule=0 17 * * *"
          - "ofelia.job-exec.{{ application }}-cron.command=/usr/local/sbin/renovate-entrypoint.sh renovate"
          - "ofelia.job-exec.{{ application }}-cron.user=12021"
          - "ofelia.job-exec.{{ application }}-cron.tty=true"
          - "ofelia.job-exec.{{ application }}-cron.no-overlap=true"
        env:
          RENOVATE_BASE_DIR: "/base"

          RENOVATE_PLATFORM: "forgejo"
          RENOVATE_ENDPOINT: "https://forgejo.{{ common_tld }}"

          # it's own bot account
          RENOVATE_USERNAME: "renovate"
          RENOVATE_TOKEN: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            65343163373539313935616261623430353864363030386666343364613665363566306262656266
            3330333262643237393938633531626431376437386631350a396539386436346632633066623937
            34616639663533666438633564343933303532363338643261343937633633643533393730373364
            3961643730633737650a326638623962343934656234666235396230326639346664383362373536
            62613161353139383439366330623631653634393533303530343266373238653035666264306563
            3666386663343731323463313933666330313462313739646534

          RENOVATE_AUTODISCOVER: "true"
          RENOVATE_GIT_AUTHOR: 'Renovate Bot <bot@renovateapp.com>'

          # for release notes
          RENOVATE_GITHUB_COM_TOKEN: &github_token !vault |
            $ANSIBLE_VAULT;1.1;AES256
            64633362666138313139333061373933653730333130636164663634653839323738363366363130
            3735373064333264336561323133613230346238616664300a396265336131303935626537643735
            30373963383939663932313039333561393138326635333565653033346364326237363134623035
            3032336539333334330a343162303163343463326461326338396533333436353334653637343961
            31393565656636386364363861303262343335346630313865353962396230356264646430303534
            6262366561396361316235373362636363666536626538656231

          RENOVATE_X_DOCKER_MAX_PAGES: "30"

          # create hostRules config using env vars
          # https://github.com/renovatebot/renovate/blob/08e6203217c69a468c17fd86b48291c3d58b1e62/lib/workers/global/config/parse/host-rules-from-env.ts#L11
          RENOVATE_DETECT_HOST_RULES_FROM_ENV: "true"

          # ghcr.io
          RENOVATE_DOCKER_GHCR_IO_USERNAME: &github_username "calvinbui"
          RENOVATE_DOCKER_GHCR_IO_PASSWORD: *github_token

          # lscr.io
          RENOVATE_DOCKER_LSCR_IO_USERNAME: *github_username
          RENOVATE_DOCKER_LSCR_IO_PASSWORD: *github_token

          # docker.io
          RENOVATE_DOCKER_DOCKER_IO_USERNAME: "calvinbui"
          RENOVATE_DOCKER_DOCKER_IO_PASSWORD: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62366338363433336333646263396430646235643136633361366335323035383736313866303434
            3665343462656134623233386266656465386232373138310a306366316163623563303939343233
            30623735623436636662323536353938623737316662333862643330646161373766616536666436
            6234346634323535610a343331626132643063666631303435303734356638323731313764393536
            31366436383734343838313231336334636165643333623464383265353336326264626530393230
            6461316338386437323364323936393230333563646638666331

          # codeberg.org
          RENOVATE_DOCKER_CODEBERG_ORG_USERNAME: "calvinbui"
          RENOVATE_DOCKER_CODEBERG_ORG_PASSWORD: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            33383338323834363837306163343866343565356138663138613764663737313261313735393836
            3161363064613461316630636630343266393262373263380a343865303936313966623730343836
            39613334346332363936356265323739353038643364386464356338356634636334393132363433
            6339393236356461620a613330626235333366616134383837383965353463643330613864346666
            34616438383063343531386230333262616639636136383963316664336135303162616364386364
            6365353561326433613261626266363034303538323737333965

          LOG_LEVEL: debug
          LOG_FILE: /tmp/renovate.log
