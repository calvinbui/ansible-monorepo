---
- hosts: homelab
  become: true
  module_defaults:
    docker_container:
      keep_volumes: false
      state: started
      restart_policy: unless-stopped
      networks_cli_compatible: true
      purge_networks: true
      networks:
        - name: "{{ network.name }}"
      dns_servers: "{{ network.dns }}"
      comparisons:
        env: allow_more_present
        labels: allow_more_present
  vars:
    network: "{{ networks.user }}"
    heimdall_name: heimdall
  tasks:
    - name: Create heimdall config folder
      file:
        path: "{{ common_directory }}/heimdall"
        state: directory
    - name: Create heimdall Container
      docker_container:
        name: heimdall
        image: linuxserver/heimdall
        env:
          PUID: "{{ common_user_id }}"
          PGID: "{{ common_group_id }}" # doesn't like root
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ common_directory }}/heimdall:/config"
          - "{{ common_directory_tv }}:/data/tvshows"
          - "{{ common_directory_movies }}:/data/movies"
        labels:
          traefik.http.routers.heimdall.entrypoints: "web"
          traefik.http.routers.heimdall.middlewares: "redirect@file"
          traefik.http.routers.heimdall.rule: "Host(`{{ common_tld }}`)"

          traefik.http.routers.heimdall-secure.entrypoints: "web-secure"
          traefik.http.routers.heimdall-secure.rule: "Host(`{{ common_tld }}`)"
          traefik.http.routers.heimdall-secure.tls: "true"
          traefik.http.routers.heimdall-secure.tls.certresolver: letsencrypt

          traefik.http.services.heimdall.loadbalancer.server.port: "80"

          com.datadoghq.ad.check_names: '["http_check"]'
          com.datadoghq.ad.init_configs: "[{}]"
          com.datadoghq.ad.instances: '[{"name":"{{ heimdall_name }}","url":"https://{{ common_tld | string }}"}]'
