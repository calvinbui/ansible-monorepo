---

- hosts: homelab

  vars:
    application: unifi-network-application

    docker_network: "{{ networks.mgmt }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}/config"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_root_group }}"
        mode: "0771"

    - name: Create mongodb container
      ansible.builtin.include_role:
        name: mongodb
      vars:
        mongo_version: 8.0.13
        mongo_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32396237343434346238646361633439393832366461343465616161373862633265613231343033
          3435376538626533393863373331323335316230623566320a623166613433656566353163353265
          34333363656236303163623064653035333233653932636131393062363232646434666439373230
          6461306334356264630a393937393363363036633265306361663933316266376532633339303130
          30363464616562666439326662343034636630663239313937623438633333663765
        mongo_command: --logpath /dev/null --quiet

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: lscr.io/linuxserver/unifi-network-application:9.3.45
        ipv4_address: "{{ docker_network.prefix }}.31"
        env:
          PUID: "{{ common_user_id | ansible.builtin.string }}"
          PGID: "{{ common_group_id | ansible.builtin.string }}"
          TZ: "{{ common_timezone }}"

          MONGO_USER: "{{ _mongo_username }}"
          MONGO_PASS: "{{ _mongo_password }}"
          MONGO_HOST: "{{ _mongo_hostname }}"
          MONGO_PORT: "{{ _mongo_port | ansible.builtin.string }}"
          MONGO_DBNAME: "{{ _mongo_database }}"
          MONGO_AUTHSOURCE: admin
        volumes:
          - "{{ config_directory }}/config:/config"
        homepage:
          name: UniFi Network Application
          group: Networking
          weight: 401
          description: "Manage UniFi Network devices"
          href: https://unifi.{{ common_local_tld }}:8443
