---

- hosts: homelab

  vars:
    application: paperless

    docker_network: "{{ networks.iot }}"

  handlers:
    - name: Restart
      ansible.builtin.command: docker restart "{{ application }}"

  tasks:
    - name: Add printer user
      ansible.builtin.user:
        name: "{{ application }}"
        create_home: false
        home: "{{ config_directory }}/consume"
        password: "$6$vgLah.l13sGfNWEP$/vrPocaGTCDC601velsai68JfVzIzaQ18OrO0Y8Q2FPpey7kmXfx/fwZcJQkLPkbnJ2SIS.S.CLBbP8iB4MfS0"
      register: _papermerge_user

    - name: Create config directory
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ _papermerge_user.uid }}"
        group: "{{ common_group_id }}"
        mode: "0750"

    - name: Create redis container
      ansible.builtin.include_role:
        name: redis
      vars:
        redis_version: 6
        redis_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66616663343636323632653230393236623832323030353239326134343865396537623838636633
          3338386137643637363764363536306162313962396436360a383164326261663939323166333065
          39383630313465306631303739386466356530326463646139383165343961326439643663616531
          6333353632313432390a366336666137353762356134383432653363333530336362626231316231
          31393165353662613235636139303464396437383763333731366439383931366236

    - name: Create postgres container
      ansible.builtin.include_role:
        name: postgres
      vars:
        postgres_version: 13
        postgres_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          34646338663564366636613638623633313633396636326562366164663737373764363462666534
          3235396632363938646334303163343030366634623565370a346261653364656233663139373530
          39363435663432613063353734373765326663343364333333613162666639346431303637393736
          3763326637366535650a656530396266386266353038333734346264636531623836356534393338
          32316163363863313262333638646363343638373430633864393665373035653930

    - name: Create tika container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-tika"
        image: ghcr.io/paperless-ngx/tika

    - name: Create gotenberg container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-gotenberg"
        image: gotenberg/gotenberg:7.5

    - name: Create webserver container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: ghcr.io/paperless-ngx/paperless-ngx:latest
        volumes:
          - "{{ config_directory }}/data:/usr/src/paperless/data"
          - "{{ config_directory }}/media:/usr/src/paperless/media"
          - "{{ config_directory }}/export:/usr/src/paperless/export"
          - "{{ config_directory }}/consume:/usr/src/paperless/consume"
        env:
          USERMAP_UID: "{{ _papermerge_user.uid | string }}"
          USERMAP_GID: "{{ common_group_id | string }}"

          PAPERLESS_REDIS: "{{ _redis_url }}"

          PAPERLESS_DBHOST: "{{ _postgres_hostname }}"
          PAPERLESS_DBPORT: "{{ _postgres_port | string }}"
          PAPERLESS_DBNAME: "{{ _postgres_database }}"
          PAPERLESS_DBUSER: "{{ _postgres_username }}"
          PAPERLESS_DBPASS: "{{ _postgres_password }}"
          PAPERLESS_DBSSLMODE: "prefer"

          PAPERLESS_TIKA_ENABLED: "true"
          PAPERLESS_TIKA_ENDPOINT: "http://{{ application }}-tika:9998"
          PAPERLESS_TIKA_GOTENBERG_ENDPOINT: "http://{{ application }}-gotenberg:3000"

          PAPERLESS_URL: "https://{{ application }}.{{ common_tld }}"
          PAPERLESS_CSRF_TRUSTED_ORIGINS: "https://{{ application }}.{{ common_tld }}"
          PAPERLESS_ALLOWED_HOSTS: "https://{{ application }}.{{ common_tld }}"
          PAPERLESS_CORS_ALLOWED_HOSTS: "https://{{ application }}.{{ common_tld }}"

          PAPERLESS_TIME_ZONE: "{{ common_timezone }}"
          PAPERLESS_OCR_LANGUAGE: "eng"
          PAPERLESS_SECRET_KEY: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            30353865316135366430366535366133663766396663653933623661393862663561353736643031
            3335353466353937343333626636636137653734646463640a366136656362653434323630623638
            34326136376232613737636661646564666239656166323561366536323530643062306334343664
            3333363561316362350a653033366431313335373531633533613838646334306533313566366332
            64383064313763323465343030356561666665643936386430306530616461313434

          PAPERLESS_OCR_IMAGE_DPI:

          PAPERLESS_LOGROTATE_MAX_BACKUPS: "0"
        traefik:
          - port: 8000
        homer:
          name: Paperless-ngx
          service: Tools
          priority: 490
          subtitle: "Document management system"
