---

- hosts: homelab

  vars:
    application: plex

    plex_main_folder: "{{ config_directory }}/Library/Application Support/Plex Media Server"

    docker_network: "{{ networks.pub }}"

  handlers:
    - name: Restart
      ansible.builtin.command: docker restart "{{ application }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_root_group }}"
        mode: "0771"

    - name: "Create {{ application }} container"
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: plexinc/pms-docker:1.28.2.6151-914ddd2b3
        ipv4_address: "{{ docker_network.prefix }}.3"
        env:
          PLEX_UID: "{{ common_user_id | string }}"
          PLEX_GID: "{{ common_root_group | string }}"
          TZ: "{{ common_timezone }}"
          NVIDIA_VISIBLE_DEVICES: "all"
          NVIDIA_DRIVER_CAPABILITIES: "all"
          # PLEX_CLAIM: ""
        volumes:
          - "{{ config_directory }}:/config"
          - "{{ common_directory_movies }}:/data/movies"
          - "{{ common_directory_tv }}:/data/tv"
          - /tmp/plex:/transcode
        device_requests:
          - driver: nvidia
            count: -1
            device_ids: []
            options: {}
            capabilities:
              - - gpu
                - video
                - compute
                - utility
        traefik:
          - port: 32400
        blackbox:
          path: /identity
        homer:
          name: Plex
          service: Sharing
          priority: 990
          subtitle: "Media server"

    - name: Create Plex profiles
      block:
        - name: Create Profiles folder
          ansible.builtin.file:
            path: "{{ plex_main_folder }}/Profiles"
            state: directory
            owner: "{{ common_user }}"
            group: "{{ common_root_group }}"
            mode: "0771"

        - name: Create profiles
          ansible.builtin.copy:
            content: "{{ item.contents }}"
            dest: "{{ plex_main_folder }}/Profiles/{{ item.name }}"
            owner: "{{ common_user }}"
            group: "{{ common_root_group }}"
            mode: "0771"
          notify: Restart
          loop:
            - name: "Android-SHIELD Android TV.xml"
              contents: |
                <?xml version="1.0" encoding="utf-8"?>
                <Client name="SHIELD Android TV">
                  <Identification>
                    <Header name="User-Agent" substring="SHIELD Android TV" />
                  </Identification>
                  <TranscodeTargets>
                    <VideoProfile container="mkv" codec="h264" audioCodec="aac" context="streaming" />
                    <MusicProfile container="flac" codec="flac" id="StereoMusicTranscodeProfile" />
                    <PhotoProfile container="jpeg" />
                  </TranscodeTargets>
                  <DirectPlayProfiles>
                    <VideoProfile container="mkv" codec="vp9,hevc,h265,mpeg1video,mpeg2video,h264,mpeg4" audioCodec="eac3,ac3,aac,mp3,mp2,pcm,flac,alac,truehd,dca" subtitleFormat="srt,ass,smi,ssa,subrip,pgs"/>
                    <VideoProfile container="mp4" codec="hevc,h265,mpeg1video,mpeg2video,h264,mpeg4" audioCodec="eac3,ac3,aac,mp3,mp2,pcm,flac,alac,truehd,dca" subtitleCodec="srt,ass,smi,ssa,subrip,pgs"/>
                    <VideoProfile container="asf" codec="wmv3,wmv3,vc1" audioCodec="wmav2,wmav2,wmapro,wmavoice,pcm" subtitleCodec="srt,ass,smi,ssa,subrip,pgs"/>
                    <VideoProfile container="avi" codec="h264,msmpeg4v3,mpeg4,mjpeg" audioCodec="mp3,ac3,eac3,dca,pcm" subtitleCodec="srt,ass,smi,ssa,subrip,pgs"/>
                    <VideoProfile container="mpeg" codec="h264,mpeg1video,mpeg2video" audioCodec="mp2,mp3,ac3,eac3,aac,pcm" subtitleCodec="srt,ass,smi,ssa,subrip,pgs"/>
                    <VideoProfile container="flv" codec="h264" audioCodec="aac,ac3,eac3,mp3,pcm" subtitleCodec="srt,ass,smi,ssa,subrip,pgs"/>
                    <VideoProfile container="mpegts" codec="h264,mpeg2video,vc1" audioCodec="mp2,mp3,ac3,eac3,dca,pcm" subtitleCodec="srt,ass,smi,ssa,subrip,pgs"/>
                    <VideoProfile container="wtv" codec="mpeg2video" audioCodec="ac3,eac3,aac,pcm"/>
                    <VideoProfile container="3gpp" codec="h264,mpeg4" audioCodec="aac,he-aac"/>
                    <MusicProfile container="mp4" codec="aac" />
                    <MusicProfile container="mp3" codec="mp2,mp3" />
                    <MusicProfile container="flac" codec="flac" />
                    <MusicProfile container="ogg" codec="vorbis" />
                    <MusicProfile container="ac3" codec="ac3"/>
                    <MusicProfile container="wav" codec="pcm"/>
                    <PhotoProfile container="jpeg,gif,bmp,png" />
                  </DirectPlayProfiles>
                  <ContainerProfiles>
                    <VideoContainer name="mp4">
                      <Limitations>
                        <Match name="part.optimizedForStreaming" value="1" />
                      </Limitations>
                    </VideoContainer>
                  </ContainerProfiles>
                  <CodecProfiles>
                    <VideoCodec name="*">
                      <Limitations>
                        <UpperBound name="video.width" value="3840" isRequired="true" />
                        <UpperBound name="video.height" value="2160" isRequired="true" />
                        <UpperBound name="video.bitDepth" value="10" />
                      </Limitations>
                    </VideoCodec>
                    <VideoCodec name="h264">
                      <Limitations>
                        <Match name="video.profile" list="baseline|main|high" />
                      </Limitations>
                    </VideoCodec>
                    <VideoAudioCodec name="aac">
                      <Limitations>
                        <UpperBound name="audio.channels" value="8" />
                      </Limitations>
                    </VideoAudioCodec>
                  </CodecProfiles>
                </Client>
            - name: "Chromecast.xml"
              contents: |
                <?xml version="1.0" encoding="utf-8"?>
                <Client name="Chromecast">
                  <!-- Author: xtrap225 -->
                  <TranscodeTargets>
                    <VideoProfile protocol="http" container="mkv" codec="h264" audioCodec="aac,mp3" context="streaming" />
                    <MusicProfile container="mkv" codec="opus" />
                    <PhotoProfile container="jpeg" />
                    <SubtitleProfile container="ass" codec="ass" />
                  </TranscodeTargets>
                  <DirectPlayProfiles>
                    <VideoProfile container="mp4" codec="Hevc,h265,mpeg1video,mpeg2video,h264,mpeg4" audioCodec="aac,mp3,mp2"/>
                    <VideoProfile container="mkv" codec="vp9,Hevc,h265,mpeg1video,mpeg2video,h264,mpeg4" audioCodec="aac,mp3,mp2,pcm,flac,alac" subtitleFormat="srt,ass"/>
                    <VideoProfile protocol="hls" container="mpegts" codec="h264" audioCodec="aac" />
                    <MusicProfile container="mp3" codec="mp2,mp3"/>
                    <MusicProfile container="mp4" codec="aac"/>
                    <MusicProfile container="flac" codec="flac"/>
                    <MusicProfile container="wav" codec="pcm"/>
                    <PhotoProfile container="jpeg,png,gif"/>
                  </DirectPlayProfiles>
                <CodecProfiles>
                    <VideoCodec name="h265,Hevc,vp9">
                      <Limitations>
                        <UpperBound name="video.width" value="3840"/>
                        <UpperBound name="video.height" value="2176"/>
                        <UpperBound name="video.bitrate" value="75000"/>
                      </Limitations>
                    </VideoCodec>
                    <VideoCodec name="h264,mpeg4">
                      <Limitations>
                        <UpperBound name="video.width" value="3840"/>
                        <UpperBound name="video.height" value="2176"/>
                        <UpperBound name="video.bitrate" value="75000"/>
                        <UpperBound name="video.bitDepth" value="10" />
                        <UpperBound name="video.level" value="42" />
                      </Limitations>
                    </VideoCodec>
                    <VideoAudioCodec name="aac,mp3">
                      <Limitations>
                        <UpperBound name="audio.channels" value="2" />
                      </Limitations>
                    </VideoAudioCodec>
                  </CodecProfiles>
                </Client>
