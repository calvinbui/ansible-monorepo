---

- hosts: homelab

  vars:
    application: victoriametrics

    docker_network: "{{ vm_network }}"

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "65534"  # nobody user
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create scrape config files directory
      ansible.builtin.file:
        path: "{{ vm_scrape_directory }}"
        state: directory
        owner: "65534"  # nobody user
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create promscrape config file
      ansible.builtin.copy:
        content: |
          global:
            scrape_interval: 60s

          scrape_config_files:
            - /scrape_config_files/*
        dest: "{{ config_directory }}/promscrape-config.yml"
        owner: "65534"  # nobody user
        group: "{{ common_group }}"
        mode: "0771"
      notify: Restart

    - name: Create victoriametrics container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: victoriametrics/victoria-metrics:v1.87.1
        command:
          - -retentionPeriod=72h
          - -selfScrapeInterval=60s

          - -promscrape.config=/promscrape-config.yml
          - -promscrape.configCheckInterval=60s
          - -promscrape.config.strictParse=true

          # fixes problem with cadvisor
          - -search.cacheTimestampOffset=10m0s
        volumes:
          - "{{ config_directory }}:/victoria-metrics-data"

          - "{{ config_directory }}/promscrape-config.yml:/promscrape-config.yml"
          - "{{ vm_scrape_directory }}:/scrape_config_files"

          - /var/run/docker.sock:/var/run/docker.sock:ro
        traefik:
          - port: 8428
            auth: page
        homer:
          name: VictoriaMetrics
          service: Monitoring
          priority: 991
          subtitle: "Monitoring system"
        comparisons:
          labels: allow_more_present

    - name: Create docker_sd scrape config
      ansible.builtin.copy:
        content: |
          - job_name: docker_containers
            docker_sd_configs:
              - host: unix:///var/run/docker.sock
            relabel_configs:
              - # Only keep containers that have a `prometheus.enable = true` label.
                action: keep
                source_labels: [__meta_docker_container_label_prometheus_enable]
                regex: true
              - # Use the task labels that are prefixed by `prometheus(.-_)`.
                action: labelmap
                regex: __meta_docker_container_label_prometheus_(.+)
                replacement: $1
              - # replace the default port 80 with our own
                action: replace
                source_labels: [__address__, __meta_docker_container_label_prometheus_port]
                regex: ([^:]+)(?::\d+)?;(\d+)
                replacement: $1:$2
                target_label: __address__
              - # replace the scheme with our own
                action: replace
                regex: (https?)
                source_labels: [__meta_docker_container_label_prometheus_scheme]
                target_label: __scheme__
              - # replace the path with our own
                action: replace
                regex: (.+)
                source_labels: [__meta_docker_container_label_prometheus_path]
                target_label: __metrics_path__
        dest: "{{ vm_scrape_directory }}/docker_sd.yml"
        owner: "65534"  # nobody user
        group: "{{ common_group }}"
        mode: "0755"
