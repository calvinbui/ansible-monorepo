---

- hosts: homelab
  become: true
  vars:
    fuel_name: fuel
    fuel_directory: "{{ common_directory }}/fuel"
    fuel_image: fuel
    network: "{{ networks.pub }}"
  module_defaults:
    docker_container:
      keep_volumes: false
      state: started
      restart_policy: unless-stopped
      networks_cli_compatible: true
      purge_networks: true
      networks:
        - name: "{{ network.name }}"
      dns_servers: "{{ network.dns }}"
      comparisons:
        env: allow_more_present
        labels: allow_more_present
  tasks:
    - name: Clone repo
      git:
        repo: https://github.com/freyta/7Eleven-Python
        dest: "{{ fuel_directory }}"
        update: true
      register: clone_repo

    - name: Build image
      docker_image:
        build:
          path: "{{ fuel_directory }}"
          pull: true
          network: "{{ networks.mgmt.name }}"
        name: "{{ fuel_image }}"
        source: build
        state: present
        force_source: true

    - name: Create 7Eleven Python
      docker_container:
        name: "{{ fuel_name }}"
        hostname: "{{ fuel_name }}"
        image: "{{ fuel_image }}"
        recreate: true
        env:
          TZ: "{{ common_timezone }}"
        labels:
          com.centurylinklabs.watchtower.enable: "false"

          traefik.http.routers.fuel.entrypoints: "web"
          traefik.http.routers.fuel.middlewares: "redirect@file"

          traefik.http.routers.fuel-secure.entrypoints: "web-secure"
          traefik.http.routers.fuel-secure.tls: "true"
          traefik.http.routers.fuel-secure.tls.certresolver: letsencrypt

          traefik.http.services.fuel.loadbalancer.server.port: "5000"
