---

- hosts: homelab

  vars:
    application: overseerr

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: sctx/overseerr:1.33.2
        env:
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ config_directory }}:/app/config"
        user: "{{ common_user_id }}:{{ common_group_id }}"
        traefik:
          - port: 5055
        homepage:
          name: Overseerr
          group: Media
          weight: 100
          description: "Request and discover media"
          widget:
            key: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              36376362623361376437353264353732313638333038353063646463613839633234633330633839
              3433623337353638393133323932653036393432343564330a366163393838356239343162643238
              39326435316262663964356338393261343330353034623465663534353238396639613638636665
              6430616530326464300a626662636364663561313762636338373638373236386633663464343332
              38313737313666373265376362383033643764636463343238623362656563626238323265636334
              39343034366338663563656363383965663063373036623132373061613734643330666666363335
              66653634303032666239393938643461653835633261633138656639316335306531626133353865
              37376238643233646436
            fields: '["pending", "processing"]'
        blackbox:
          path: /api/v1/status

    - name: Configure
      json_patch: # noqa fqcn[action]
        src: "{{ config_directory }}/settings.json"
        pretty: true
        operations:
          - op: add
            path: "{{ item.key }}"
            value: "{{ item.value }}"
      loop: "{{ _overseerr_configuration | dict2items }}"
      notify: Restart
      vars:
        _overseerr_configuration:
          main/applicationUrl: "https://{{ application }}.{{ common_tld }}"
          main/cacheImages: true
          main/localLogin: false
          main/trustProxy: true

          plex/name: plex
          plex/ip: plex.{{ networks.pub.name }}
          plex/webAppUrl: "https://plex.{{ common_tld }}"

          # radarr/name: Radarr
          # radarr/hostname: "radarr.{{ networks.pub.name }}"
          # radarr/port: 7878
          # radarr/apiKey: "{{ radarr_api_key }}"
          # radarr/useSsl: false
          # radarr/externalUrl: "https://radarr.{{ common_tld }}"
          #
          # sonarr/name: Sonarr
          # sonarr/hostname: "sonarr.{{ networks.pub.name }}"
          # sonarr/port: 8989
          # sonarr/apiKey: "{{ sonarr_api_key }}"
          # sonarr/useSsl: false
          # sonarr/externalUrl: "https://sonarr.{{ common_tld }}"
