---

- hosts: homelab

  vars:
    application: overseerr

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: sctx/overseerr:1.32.2
        env:
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ config_directory }}:/app/config"
        user: "{{ common_user_id }}:{{ common_group_id }}"
        traefik:
          - port: 5055
        homer:
          name: Overseerr
          service: Download
          priority: 991
          subtitle: "Request and discover media"

    - name: Configure
      json_patch: # noqa fqcn[action]
        src: "{{ config_directory }}/settings.json"
        pretty: true
        operations:
          - op: add
            path: "{{ item.key }}"
            value: "{{ item.value }}"
      loop: "{{ _overseerr_configuration | dict2items }}"
      notify: Restart
      vars:
        _overseerr_configuration:
          main/applicationUrl: "https://{{ application }}.{{ common_tld }}"
          main/cacheImages: true
          main/localLogin: false
          main/trustProxy: true

          plex/name: plex
          plex/ip: plex.{{ networks.pub.name }}
          plex/webAppUrl: "https://plex.{{ common_tld }}"

          # radarr/name: Radarr
          # radarr/hostname: "radarr.{{ networks.pub.name }}"
          # radarr/port: 7878
          # radarr/apiKey: "{{ radarr_api_key }}"
          # radarr/useSsl: false
          # radarr/externalUrl: "https://radarr.{{ common_tld }}"
          #
          # sonarr/name: Sonarr
          # sonarr/hostname: "sonarr.{{ networks.pub.name }}"
          # sonarr/port: 8989
          # sonarr/apiKey: "{{ sonarr_api_key }}"
          # sonarr/useSsl: false
          # sonarr/externalUrl: "https://sonarr.{{ common_tld }}"
