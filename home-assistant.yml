---

- hosts: homelab

  vars:
    application: home-assistant
    docker_network: "{{ networks.iot }}"

    home_assistant_configuration: "{{ config_directory }}/config/configuration.yaml"
    home_assistant_automations_dir: "{{ config_directory }}/config/automations"
    home_assistant_addons_dir: "{{ config_directory }}/config/addons"

    home_assistant_integrations_dir: "{{ config_directory }}/config/integrations"
    home_assistant_integrations:
      google_secure_devices_pin: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        32323164346637373262363162386333636531326133336139633236626138356136333835343965
        3438613663613164333634363137303030653662646462640a373163353661333732616665313761
        32303535316530656232363833613662386630653435303731366464346563326630313035356533
        3134336332663365390a633966653764313164306336316663326635313930306238646363303538
        6630
      influxdb_token: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        38656665356237313932316331313366616663333365326431636634623363353638643937623239
        6634646436663635363936616230306165313836343035370a393735386535356131356265303338
        64366161373563653763663562383538336662366139383431656232376633366139333334306262
        3834396436346634630a363366396337366133316563386437663364353461323134656465396231
        35643232666132323739363439326161623333363630643439666336353662343530303731303666
        64376537356538393537316233633332393865346665363530323136353762646234623439363535
        63393766663239653463656534306363626235646564663265383833323230336234383731623761
        35323663306661363036393732363765313338663432356665363230323837643734336564616234
        3338
      caldav:
        # includes username and password as it wasn't working under separately
        - url: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            31383238363263333634333764663063303665313639396165316432666637396133383430356135
            3739323833313935383432616231333636306564373032650a666364363366303437323735313066
            32393230616137633631653738643536366563626465353539613939663133373764333664623264
            6365313731363930620a616531333731323661633936623165346139313766343466633338323661
            66653937353330343464633938353832646437613361353963616334653464396633353365306332
            66653336383164303333653763376435633766633161653166326363316334653766633232383931
            32666166363564336533313739633963643864613734323231363636383439313464646136303936
            30316365316666393132373533623564626233626439376636363431363832313162386464613031
            66316235396162663534373063393265383762386134333265363638396632336162
          custom_calendars:
            - name: Calvin's Calendar
              calendar: My Calendar
              search: ".*"
      waste_collection_schedule:
        source: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63313266613637353335366239353262323362656265636564643030393231353932353239643839
          3862366134396231396264616530346339623464643164610a376137643862336434666566633861
          38343437626564313232356632653632323532326536326437383162323966393364333931616330
          3239323335636635360a663638643431633831393139306638653332313735636636643261333037
          36636165663233316463393634346163623834653131366431393132303137326562
        suburb: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64343163353536383538363532343031323833323233356463306631356134666539623161303238
          3436663566393637386133353134663866623738396234320a323834356633323739373136323332
          66396436353433643536363065393237353461636239646433633732343734636432313763353230
          3339613165343139320a376265346366656338623635646464346564373831353639323036383866
          36396362373932353163306664333535346661363337656433663134656234326435
        street_name: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66306635353930343566386535643266653030646135333265326532323230323530396236323561
          3132343731323837323464626638653433343238616664350a653337653066343038636637383265
          36626366396435613533643766303461666136313965303861653238363635316233313538646462
          6662353865326166300a633663653937326661383461663464383563346434636339303564316661
          66663837653939393532353663663737313330623036613930646239313830326163
        street_number: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36323465636534366231663365323462656465336364636435366438366439356533643931616363
          6532363838303839303733343535373730613462323763630a393335363962396662646563346131
          64313434616266613035636335383030666130363861646638653530616662316638616636653135
          3832336238303833660a623963323863633765373262363332303565323935613833653839346535
          3631
      home_connect_alt:
        client_id: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39323564303263323530616166383761383933396234336437663538623766363165336237373733
          6533373133396537313931663337616338376333316339330a366664663939633937376439386339
          35633962383732333539303034633038356137633061643364326161616561356261656632306666
          6637333233316262330a363962393264363365636639666539303164383434643336353438393432
          39346661366132336562366135366565393433653535333363386334393632653735353261393934
          33643936343462313238613266636136326163363336316133376134346662353262613330626264
          63313833346463396661623163343637353738386566313336316131353436336563626266363566
          65613134353364623236
        client_secret: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31633936333337303936663837363033303732646133303436333934303066306564613265643937
          3566333833366365333264626230373664626137336631320a323363353762313063666664623964
          30323232373837323634393166333462366263316561616435303332313062373035346661646435
          6336323464353334370a626365626138613232656665666264373932303962376438663331366665
          66323365383462323332613939646363346363333766663366653932636333373937366636393539
          34373232363838383963646630386661663164613130303764653130323261333336343866353264
          62343439616561383936643764376561313038366266336336333030396362666238333166643863
          38363963653031386462
      plex_token: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        30333336393361333738303232653731646462646461393236663961303634343964643934666433
        6566653139613134643731666232383766393764323630610a386533343236666630653337656562
        32366363366263646137646166633830313837386632653333306432663661656532353366333933
        6566636235326463660a343663323837623165333261663264383135636631316465396539363861
        65326332333735346637636663316262633634313634346132376661333762653130

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user_id }}"
        group: "{{ common_root_group }}"
        mode: "0771"

    - name: Create postgres container
      tags:
        - integrations
      ansible.builtin.import_role:
        name: postgres
      vars:
        postgres_version: 16
        postgres_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32633539336137363933353436636432623537373832643930306335333333616364376162346332
          3837343131623965653961313661643363353563626566350a346334356436653337393738383535
          36623461656638313732393732363933393734326438646462633830613238353535303637323431
          6562633838373165360a343239626161646138666432316566636337343530633963326666326665
          61306432353564653366363434666232343731343437343439306361346561366536643635353864
          3266623034333431363434306365336361333932613164306264

    - name: Create influxdb container
      tags:
        - integrations
      ansible.builtin.import_role:
        name: influxdb
      vars:
        influxdb_version: 2.7
        influxdb_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39383139643961303364626537306531346530373162353465356237386332636239343238633663
          6134353665323265386338633634393038663665316239390a623663343530666462623031633662
          37656435353865356539353566656133643339656130623938393639303631303665343431393963
          6263613830323737390a356566613732656163303430313162303330323330393461653432376166
          37333531656136633639373735616532663264633030373365623030336239666262
        influxdb_traefik:
          enable: "true"
        influxdb_homepage:
          enable: "true"
          name: "Home Assistant InfluxDB"
          description: "Long term data from devices"
          group: Home Automation
          weight: 300

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: ghcr.io/home-assistant/home-assistant:2024.2.2
        env:
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ config_directory }}/config:/config"
          - /etc/localtime:/etc/localtime:ro
        ipv4_address: "{{ docker_network.prefix }}.253"
        traefik:
          - name: "{{ application }}-short"
            port: 8123
            rule: Host(`home.{{ common_tld }}`)
          - port: 8123
            rule: Host(`{{ application }}.{{ common_tld }}`)
        homepage:
          name: Home Assistant
          group: Home Automation
          weight: 50
          description: "Home automation"
          href: "https://home.{{ common_tld }}"
        network_mode: "host"
        privileged: true

    - name: Wait for config file
      ansible.builtin.wait_for:
        path: "{{ home_assistant_configuration }}"

    - name: Configure default settings
      yedit: # noqa fqcn[action]
        src: "{{ home_assistant_configuration }}"
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      notify: Restart
      loop: "{{ _ha_config | dict2items }}"
      vars:
        _ha_config:
          http.use_x_forwarded_for: true
          http.trusted_proxies:
            - "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] | string }}"

    - name: Configure integrations
      tags:
        - integrations
      block:
        - name: Create integration folder
          ansible.builtin.file:
            path: "{{ home_assistant_integrations_dir }}"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"

        - name: Template integrations
          ansible.builtin.template:
            src: "{{ item }}"
            dest: "{{ home_assistant_integrations_dir }}/{{ item | basename | regex_replace('\\.j2$', '') }}"
            mode: "0644"
            validate: "echo checking %s && docker exec {{ application }}/usr/local/bin/hass --script check_config --config /config"
          notify: Restart
          with_fileglob:
            - "{{ files_directory }}/integrations/*"

        - name: Include integration config within main configuration file
          ansible.builtin.lineinfile:
            path: "{{ home_assistant_configuration }}"
            regexp: "^{{ item | basename | regex_replace('\\.yaml.j2$', '') }}"
            line: "{{ item | basename | regex_replace('\\.yaml.j2$', '') }}: !include integrations/{{ item | basename | regex_replace('\\.j2$', '') }}"
            state: present
          notify: Restart
          with_fileglob:
            - "{{ files_directory }}/integrations/*"

    - name: Install Addons
      block:
        - name: Create addons folder
          ansible.builtin.file:
            path: "{{ home_assistant_addons_dir }}"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"

        - name: Create python_scripts folder
          tags:
            - integrations
          ansible.builtin.file:
            path: "{{ config_directory }}/config/python_scripts"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"
          notify: Restart

        - name: Copy Google Service Account file
          tags:
            - integrations
          ansible.builtin.copy:
            src: "{{ files_directory }}/google-service-account.json"
            dest: "{{ home_assistant_integrations_dir }}/google-service-account.json"
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"
          notify: Restart

        - name: Create Eufy Security WS container
          ansible.builtin.include_role:
            name: docker_container
          vars:
            name: "eufy-security-ws"
            image: bropat/eufy-security-ws:1.7.1
            env:
              USERNAME: "{{ application }}{{ common_email_to }}"
              PASSWORD: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                32663633343362623462393864346631393638613933346166653764396530316264616364613065
                6339376630643833346639653530333835653037613363620a663464623137663031313931356432
                64383264306365656430363137353965643963313136616637626534396362376436626466303965
                3839336635646338380a386564356461393564373236333464343835646535663462303862303361
                6162
              LANGUAGE: "{{ common_language_iso_639 }}"
              COUNTRY: "{{ common_country_iso_3166 }}"
              TRUSTED_DEVICE_NAME: "{{ application }}"
              ACCEPT_INVITATIONS: "true"
            volumes:
              - "{{ home_assistant_addons_dir }}/eufy-security-ws:/data"

        - name: Create govee2mqtt container
          ansible.builtin.include_role:
            name: docker_container
          vars:
            name: "govee2mqtt"
            image: ghcr.io/wez/govee2mqtt:latest
            env:
              GOVEE_EMAIL: govee{{ common_email_to }}
              GOVEE_PASSWORD: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                63626135336533336464663233333834663839333735346164636336306138383234373130666339
                3638653662623462343666623664663864313562383430330a616631333435396536376531386234
                63313266353363343031663036656634326661363766616137373736346666333032326365303334
                6230363664313261300a373161353363656564613964323231666333613838636538306236353739
                31613739653138396132363061613737643333363638623761353033396334623865
              GOVEE_API_KEY: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                30376266623532346465363265323737643431373664386430376532333665336261383830393330
                3963383166626466653764316163636435383064343832330a303835613061663831353962616433
                32376331303563623963313065363632656633393632303838363832336366336439363538636231
                3761346139666433320a656130363838636537656631633266373361623463336233363136636439
                39663838646335623339326136623861646633626461376233373935636134393830343532623966
                6338613462656433343035393333663239323331316563303266

              GOVEE_MQTT_HOST: mosquitto.{{ docker_network.name }}
              GOVEE_MQTT_PORT: "1883"
              GOVEE_MQTT_USER: "govee2mqtt"
              GOVEE_MQTT_PASSWORD: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                34643464303164333833363364316261356339643035316664386263636538346462316532626435
                3432373866383966383863326334333631326361313565390a326561333466623832626464633937
                38323162366534663931303830363535363436613962313466393836363863656533323464373132
                3865313737383932330a323138396666363061376335633832326530326634653032363535633033
                39633232363530663238613331316432346634653661373063396135333937386532

              TZ: "{{ common_timezone }}"

    - name: Configure Automations
      tags:
        - automations
      block:
        - name: Split ui created automations
          ansible.builtin.lineinfile:
            dest: "{{ home_assistant_configuration }}"
            search_string: 'automation: !include automations.yaml'
            line: 'automation ui: !include automations.yaml'
            state: present
          notify: Restart

        - name: Create custom automations folder
          ansible.builtin.file:
            path: "{{ home_assistant_automations_dir }}"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"
          notify: Restart

        - name: Add custom automations folder to configuration
          ansible.builtin.lineinfile:
            dest: "{{ home_assistant_configuration }}"
            line: 'automation custom: !include_dir_merge_list automations/'
            state: present
          notify: Restart

        - name: Copy custom automations
          ansible.builtin.copy:
            src: "{{ files_directory }}/automations/"
            dest: "{{ home_assistant_automations_dir }}"
            mode: "0644"
          notify: Restart

    - name: Copy dashboard
      tags:
        - dashboard
      ansible.posix.synchronize:
        src: "{{ files_directory }}/ui_lovelace_minimalist/"
        dest: "{{ config_directory }}/config/ui_lovelace_minimalist/"
        delete: true
        owner: false
        group: false
        perms: false

    - name: Install HACS
      community.docker.docker_container_exec:
        container: "{{ application }}"
        command: bash -c "wget -O - https://get.hacs.xyz | bash -"
        chdir: /config
      notify: Restart
      register: _command_result
      changed_when: "'HACS directory already exist' not in _command_result.stdout"
