---

- hosts: homelab

  vars:
    application: home-assistant
    docker_network: "{{ networks.iot }}"

    home_assistant_configuration: "{{ config_directory }}/config/configuration.yaml"
    home_assistant_automations_dir: "{{ config_directory }}/config/automations"
    home_assistant_addons_dir: "{{ config_directory }}/config/addons"

    home_assistant_integrations_dir: "{{ config_directory }}/config/integrations"
    home_assistant_integrations:
      google_secure_devices_pin: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        32323164346637373262363162386333636531326133336139633236626138356136333835343965
        3438613663613164333634363137303030653662646462640a373163353661333732616665313761
        32303535316530656232363833613662386630653435303731366464346563326630313035356533
        3134336332663365390a633966653764313164306336316663326635313930306238646363303538
        6630
      influxdb_token: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        38656665356237313932316331313366616663333365326431636634623363353638643937623239
        6634646436663635363936616230306165313836343035370a393735386535356131356265303338
        64366161373563653763663562383538336662366139383431656232376633366139333334306262
        3834396436346634630a363366396337366133316563386437663364353461323134656465396231
        35643232666132323739363439326161623333363630643439666336353662343530303731303666
        64376537356538393537316233633332393865346665363530323136353762646234623439363535
        63393766663239653463656534306363626235646564663265383833323230336234383731623761
        35323663306661363036393732363765313338663432356665363230323837643734336564616234
        3338
      ics_calendar:
        # https://www.industrialrelations.nsw.gov.au/public-holidays/public-holidays-in-nsw/
        - name: NSW Public Holidays 2021-2023
          url: https://staticontent.dpc.nsw.gov.au/ir/calendar/NSW-Public-Holidays-dates-2021-2023.ics
          user_agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36
          parser: ics
      caldav:
        - url: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            39643837333964346232623333653161363832663339656365663334333265306534643134653934
            6165363135623531646635356262616233316362313966330a313539636137376562653862313237
            64663264636130333034643733386437663864386637366134306461313161323930383938656464
            6233356433386532300a336561626262376236306235353337623234656538323233636564623032
            35326566336239373137306636393435353331656433366466616637643630373637646362393431
            64326339333939303339363963393431656439653761313338643635366432383761303437633933
            64613264643732383232633864366431353634386237633430326464353233393538666635643261
            62643837356365366330
          username: calvin
          password: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            33343663623633396334303736373364373532616564316634636130303164333332343964643336
            3437613239356664336437373531643539373630366435390a313939353430383031653432633334
            63336134373733616330303135356431643666383266643138396363333061343238623438313364
            3839376136636630300a386465373466363465343634623835316231326362633565663264376436
            32386664393066346430393739333038653866326264666463396164303035333964
          custom_calendars:
            - name: Calvin's Calendar
              calendar: My Calendar
              search: ".*"
      waste_collection_schedule:
        source: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63313266613637353335366239353262323362656265636564643030393231353932353239643839
          3862366134396231396264616530346339623464643164610a376137643862336434666566633861
          38343437626564313232356632653632323532326536326437383162323966393364333931616330
          3239323335636635360a663638643431633831393139306638653332313735636636643261333037
          36636165663233316463393634346163623834653131366431393132303137326562
        suburb: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64343163353536383538363532343031323833323233356463306631356134666539623161303238
          3436663566393637386133353134663866623738396234320a323834356633323739373136323332
          66396436353433643536363065393237353461636239646433633732343734636432313763353230
          3339613165343139320a376265346366656338623635646464346564373831353639323036383866
          36396362373932353163306664333535346661363337656433663134656234326435
        street_name: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          66306635353930343566386535643266653030646135333265326532323230323530396236323561
          3132343731323837323464626638653433343238616664350a653337653066343038636637383265
          36626366396435613533643766303461666136313965303861653238363635316233313538646462
          6662353865326166300a633663653937326661383461663464383563346434636339303564316661
          66663837653939393532353663663737313330623036613930646239313830326163
        street_number: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          36323465636534366231663365323462656465336364636435366438366439356533643931616363
          6532363838303839303733343535373730613462323763630a393335363962396662646563346131
          64313434616266613035636335383030666130363861646638653530616662316638616636653135
          3832336238303833660a623963323863633765373262363332303565323935613833653839346535
          3631
        recyclesmart_email: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39373438363039396239613430366639643238326334616563303434313638353735346331376234
          6535396234326130356436356462303637343639323336330a333233353735376530343966383737
          36626566326630393632376137633461636336663231613935333463633936323437313436643965
          3933373937306631380a336536336538663639386164646666393936353638303964376330613962
          32613633366231633265333331643866666435663164333931383463633764383532
        recyclesmart_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32316563643433636565623330663233343138353463633439656335353639663034313838653635
          3830376334363031623439643137316563656164376665630a363635306163366636356636323063
          38356163393935356339363034613364643964323363343332663432646233356465353839386539
          3739613838616132360a383264616436663530376439323636636435353837393239633938383164
          6636
      home_connect_alt:
        client_id: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39323564303263323530616166383761383933396234336437663538623766363165336237373733
          6533373133396537313931663337616338376333316339330a366664663939633937376439386339
          35633962383732333539303034633038356137633061643364326161616561356261656632306666
          6637333233316262330a363962393264363365636639666539303164383434643336353438393432
          39346661366132336562366135366565393433653535333363386334393632653735353261393934
          33643936343462313238613266636136326163363336316133376134346662353262613330626264
          63313833346463396661623163343637353738386566313336316131353436336563626266363566
          65613134353364623236
        client_secret: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31633936333337303936663837363033303732646133303436333934303066306564613265643937
          3566333833366365333264626230373664626137336631320a323363353762313063666664623964
          30323232373837323634393166333462366263316561616435303332313062373035346661646435
          6336323464353334370a626365626138613232656665666264373932303962376438663331366665
          66323365383462323332613939646363346363333766663366653932636333373937366636393539
          34373232363838383963646630386661663164613130303764653130323261333336343866353264
          62343439616561383936643764376561313038366266336336333030396362666238333166643863
          38363963653031386462
      transport_nsw_api_key: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          63663237636337363865616435366437353135643737643533303365643338626535306662353766
          6333353735653330336434663463393034363661623432300a653137363231663435653166393236
          37393230326639663335333765356330353633303438646537633138366664336461316337346136
          3062313435343936370a323135373263396534366530616165633636363466386634333066623033
          65373738316264353466623830323932666130633364313538633638636232356638336534636233
          6135653536656564333031343730383932666131386636396466

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user_id }}"
        group: "{{ common_root_group }}"
        mode: "0771"

    - name: Create postgres container
      tags:
        - integrations
      ansible.builtin.import_role:
        name: postgres
      vars:
        postgres_version: 15
        postgres_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          32633539336137363933353436636432623537373832643930306335333333616364376162346332
          3837343131623965653961313661643363353563626566350a346334356436653337393738383535
          36623461656638313732393732363933393734326438646462633830613238353535303637323431
          6562633838373165360a343239626161646138666432316566636337343530633963326666326665
          61306432353564653366363434666232343731343437343439306361346561366536643635353864
          3266623034333431363434306365336361333932613164306264

    - name: Create influxdb container
      tags:
        - integrations
      ansible.builtin.import_role:
        name: influxdb
      vars:
        influxdb_version: 2.7
        influxdb_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39383139643961303364626537306531346530373162353465356237386332636239343238633663
          6134353665323265386338633634393038663665316239390a623663343530666462623031633662
          37656435353865356539353566656133643339656130623938393639303631303665343431393963
          6263613830323737390a356566613732656163303430313162303330323330393461653432376166
          37333531656136633639373735616532663264633030373365623030336239666262
        influxdb_traefik:
          enable: "true"
        influxdb_homer:
          enable: "true"
          name: "Home Assistant InfluxDB"
          subtitle: "Long term data from devices"
          service: Monitoring
          priority: 250

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: ghcr.io/home-assistant/home-assistant:2023.4.4
        env:
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ config_directory }}/config:/config"
          - /etc/localtime:/etc/localtime:ro
        ipv4_address: "{{ docker_network.prefix }}.20"
        traefik:
          - name: "{{ application }}-short"
            port: 8123
            rule: Host(`home.{{ common_tld }}`)
          - port: 8123
            rule: Host(`{{ application }}.{{ common_tld }}`)
        homer:
          name: Home Assistant
          service: Home
          priority: 950
          subtitle: "Home automation"
          url: "https://home.{{ common_tld }}"
        network_mode: "host"
        privileged: true

    - name: Wait for config file
      ansible.builtin.wait_for:
        path: "{{ home_assistant_configuration }}"

    - name: Configure default settings
      yedit: # noqa fqcn[action]
        src: "{{ home_assistant_configuration }}"
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      notify: Restart
      loop: "{{ _ha_config | dict2items }}"
      vars:
        _ha_config:
          http.use_x_forwarded_for: true
          http.trusted_proxies:
            - "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] | string }}"

    - name: Configure integrations
      tags:
        - integrations
      block:
        - name: Create integration folder
          ansible.builtin.file:
            path: "{{ home_assistant_integrations_dir }}"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"

        - name: Template integrations
          ansible.builtin.template:
            src: "{{ item }}"
            dest: "{{ home_assistant_integrations_dir }}/{{ item | basename | regex_replace('\\.j2$', '') }}"
            mode: "0644"
            validate: "echo checking %s && docker exec {{ application }}/usr/local/bin/hass --script check_config --config /config"
          notify: Restart
          with_fileglob:
            - "{{ files_directory }}/integrations/*"

        - name: Include integration config within main configuration file
          ansible.builtin.lineinfile:
            path: "{{ home_assistant_configuration }}"
            regexp: "^{{ item | basename | regex_replace('\\.yaml.j2$', '') }}"
            line: "{{ item | basename | regex_replace('\\.yaml.j2$', '') }}: !include integrations/{{ item | basename | regex_replace('\\.j2$', '') }}"
            state: present
          notify: Restart
          with_fileglob:
            - "{{ files_directory }}/integrations/*"

    - name: Install Addons
      block:
        - name: Create addons folder
          ansible.builtin.file:
            path: "{{ home_assistant_addons_dir }}"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"

        - name: Create python_scripts folder
          tags:
            - integrations
          ansible.builtin.file:
            path: "{{ config_directory }}/config/python_scripts"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"
          notify: Restart

        - name: Copy Google Service Account file
          tags:
            - integrations
          ansible.builtin.copy:
            src: "{{ files_directory }}/google-service-account.json"
            dest: "{{ home_assistant_integrations_dir }}/google-service-account.json"
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"
          notify: Restart

        - name: Create Eufy Security WS container
          ansible.builtin.include_role:
            name: docker_container
          vars:
            name: "eufy-security-ws"
            image: bropat/eufy-security-ws:1.3.5
            env:
              USERNAME: "{{ application }}{{ common_email_to }}"
              PASSWORD: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                32663633343362623462393864346631393638613933346166653764396530316264616364613065
                6339376630643833346639653530333835653037613363620a663464623137663031313931356432
                64383264306365656430363137353965643963313136616637626534396362376436626466303965
                3839336635646338380a386564356461393564373236333464343835646535663462303862303361
                6162
              LANGUAGE: "{{ common_language_iso_639 }}"
              COUNTRY: "{{ common_country_iso_3166 }}"
              TRUSTED_DEVICE_NAME: "{{ application }}"
              ACCEPT_INVITATIONS: "true"
            volumes:
              - "{{ home_assistant_addons_dir }}/eufy-security-ws:/data"

    - name: Configure Automations
      tags:
        - automations
      block:
        - name: Split ui created automations
          ansible.builtin.lineinfile:
            dest: "{{ home_assistant_configuration }}"
            search_string: 'automation: !include automations.yaml'
            line: 'automation ui: !include automations.yaml'
            state: present
          notify: Restart

        - name: Create custom automations folder
          ansible.builtin.file:
            path: "{{ home_assistant_automations_dir }}"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"
          notify: Restart

        - name: Add custom automations folder to configuration
          ansible.builtin.lineinfile:
            dest: "{{ home_assistant_configuration }}"
            line: 'automation custom: !include_dir_merge_list automations/'
            state: present
          notify: Restart

        - name: Copy custom automations
          ansible.builtin.copy:
            src: "{{ files_directory }}/automations/"
            dest: "{{ home_assistant_automations_dir }}"
            mode: "0644"
          notify: Restart

    - name: Copy dashboard
      tags:
        - theme
      ansible.posix.synchronize:
        src: "{{ files_directory }}/ui_lovelace_minimalist/"
        dest: "{{ config_directory }}/config/ui_lovelace_minimalist/"
        delete: true
        owner: false
        group: false
        perms: false

    - name: Install HACS
      community.docker.docker_container_exec:
        container: "{{ application }}"
        command: bash -c "wget -O - https://get.hacs.xyz | bash -"
        chdir: /config
      notify: Restart
      register: _command_result
      changed_when: "'HACS directory already exist' not in _command_result.stdout"
