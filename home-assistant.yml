---

- hosts: homelab

  vars:
    application: home-assistant

    docker_network: "{{ networks.iot }}"

  handlers:
    - name: Restart
      ansible.builtin.command: docker restart "{{ application }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0771"
      register: _config_dir

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: ghcr.io/home-assistant/home-assistant:stable
        env:
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ _config_dir.path }}:/config"
          - /etc/localtime:/etc/localtime:ro
        traefik:
          - port: 8123
            rule: Host(`home.{{ common_tld }}`)
        homer:
          name: Home Assistant
          service: Tools
          priority: 795
          subtitle: "Home automation"
          url: "https://home.{{ common_tld }}"
        network_mode: "host"
        privileged: true

    - name: Wait for config file
      ansible.builtin.wait_for:
        path: "{{ _config_dir.path }}/configuration.yaml"

    - name: Configure default settings
      yedit:
        src: "{{ _config_dir.path }}/configuration.yaml"
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      notify: Restart
      loop: "{{ _ha_config | dict2items }}"
      vars:
        _ha_config:
          http.use_x_forwarded_for: true
          http.trusted_proxies:
            - "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] | string }}"

    - name: Install Addons
      block:
        - name: Create addons folder
          ansible.builtin.file:
            path: "{{ _config_dir.path }}/addons"
            state: directory
            owner: "{{ common_root_id }}"
            group: "{{ common_root_group }}"
            mode: "0771"
          register: _addons_dir

        - name: Create Eufy Security WS container
          ansible.builtin.include_role:
            name: docker_container
          vars:
            name: "eufy-security-ws"
            image: bropat/eufy-security-ws
            env:
              USERNAME: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                65333435353932346564656234626632643261396239663732336531633564613662626635623135
                3361663932376664386438303532346634663138303764300a313363623663656638623763376332
                34336239666239333432383533353435656334356263383764613166326363386439396539373166
                6133396266633663630a363064633339356262363138363034623563613861346330313862333231
                6534
              PASSWORD: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                66333734646634616635306165633766386266336632633139633934323537653061643935323230
                3066313664366663626334316631383031333835623437380a336163316330636136373965616430
                63333036393739333465373863383862623632626130393138633633393065643661663061643537
                6336656161643963340a623566663033303765386366303764313366353931326331353337363365
                38616532323133313261363537386438623266316361303432303834303535376463
              LANGUAGE: "{{ common_language_iso_639 }}"
              COUNTRY: "{{ common_country_iso_3166 }}"
            volumes:
              - "{{ _addons_dir.path }}/eufy-security-ws:/data"

    - name: Configure integrations
      block:
        - name: Create integration configurations
          ansible.builtin.template:
            src: "{{ files_directory }}/integration_template.yaml.j2"
            dest: "{{ _config_dir.path }}/{{ item.key }}.yaml"
            mode: "0644"
          notify: Restart
          loop: "{{ _home_assistant_config_integrations | dict2items }}"

        - name: Include integration config within main configuration file
          ansible.builtin.lineinfile:
            path: "{{ _config_dir.path }}/configuration.yaml"
            regexp: "^{{ item.key }}"
            line: "{{ item.key }}: !include {{ item.key }}.yaml"
            state: present
          notify: Restart
          loop: "{{ _home_assistant_config_integrations | dict2items }}"
      vars:
        _home_assistant_config_integrations:
          notify:
            - name: MOBILE_PHONES
              platform: group
              services:
                - service: mobile_app_calvin_s_galaxy_s21
                - service: mobile_app_tammy_s_galaxy_s21

          home_connect:
            client_id: A30F3A70602165DB8E8C00874C9009C0C0B6DBC365F724C4176DDAE2023D32C3
            client_secret: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              31666132393736343639626338396430313139303834656562343039616230373164336336383863
              6231633530396437323938343132636634343965643936620a366431363630393038626632663065
              32386664333065386533323666666430366136373261393536333238326562643835663664613332
              6664336431376632370a366336303862346431643531313662363266363332373836333031313732
              37383162313531636362383938343735613431636431323136396565313665396661653436386435
              63366162653361326531336131653635343461656239313265383434666266646633363630616632
              30353966646137306431643739633436623364356137616261393134363031316530333430643634
              35373332653130633762

          google_assistant:
            project_id: home-assistant-14ee3
            report_state: true
            expose_by_default: true
            secure_devices_pin: !vault |
              $ANSIBLE_VAULT;1.1;AES256
              32323164346637373262363162386333636531326133336139633236626138356136333835343965
              3438613663613164333634363137303030653662646462640a373163353661333732616665313761
              32303535316530656232363833613662386630653435303731366464346563326630313035356533
              3134336332663365390a633966653764313164306336316663326635313930306238646363303538
              6630
            service_account:
              private_key: !vault |
                $ANSIBLE_VAULT;1.1;AES256
                35313439663965396431333233386338336531383031636165646566653734383930666432306331
                6334656466366539313165623332333837616530363934310a393061646438376133366263396135
                63653135373530343461336338663666363632393535623130633061353336656438633162656663
                3363306137303637660a393735353662613663613966306666306630356331323162356631396239
                63316234653739336232626662646633316262373930303130316564623563663339626532666432
                30323436653361646239313732363965666432316532393661343535373534613435653766313435
                39623063633533306639623334323739653135623462323863663163386531373731613464666363
                37316264656536343864666334653864343565396132353130653531623935393432303934616565
                31326164393638323761396134656366666139653765353039333836376635333137346566386237
                62386239636561356337633463326439623765373636656561343862663733616130373263616232
                34363937643933643762666435313037366631653731666562633638383432373436646536636161
                61323166656463636636663432653636616237373336346536393036383838306538663036323738
                32643837326563396165616664373062643135633534333433653434643939633061323534326539
                34613462313531646538626563646638326139663365643763323532363162356532653465646461
                62323837373331666536613961343136346239613466356631613034666235316239343631613766
                64373833663233393332366161376434366264616539353232333536343838376635313531663563
                37653538666232616436383262623263636639343135313338353865616439373162366137613966
                35333763326638393135623032326333336137353966303365653764303166653933363936653365
                37666663363366353037313562653234336437643966383265633637313866353962373830346339
                33343837353766323532653731386230633336643564626265636436396237663638366535323835
                33656533653630633338353133373930343138663332663636643430346532323534356165636361
                30356464643133623762623938306532646162333937373433656164626431356462633337383832
                37623836653563363734663831653033396537313166323231393437323031316466623066373332
                37393865393231306537393037666638356230363666623237353663363230303662323831306134
                39393935656434643565383761323163373236653261633735613533353566383635633736646536
                61333164323561326131376565353965613035666462613064363131383837653536643265383031
                38366139346366336338643638383438313332353331383530356335376338396335373563383366
                37653665616162363638366366613830313639663731636639616634373563373366663735383666
                63376363653638656431323964353735353434313538613037376634346632653861613235656363
                39626563353037613337623739383739343938303438643133313333313038316436386637656536
                66653734653439363862306235323430343465616263636161346662323530353134383463373731
                65383166623739313061353362343638313163623935383565373463343439393738313837323237
                34353064346337633462643733323662313366323937363365646131373734366566373431323830
                36313661613165633564336334613037626536353339623661633030626637346364656132626437
                38353338656362303266666135366432663463383035383362333863383831323736383261383963
                64343431326566616135666638363166393664613561373363613061646161306130666536353839
                65623134666339303930353966613238326133356633376266336533386631383933363564613465
                35653235346263323538353830323233313864643562636538373462353161346236633133313232
                36343537623930333665613932366630333862303565363264353433623239306133316462373536
                39653434643062353030303863616232376232313762346436646662363161383436363237393163
                37666666386464386338333230356635663665396661316665306162383136636266636137633531
                65373034346565623830356164373839356363363036383434363433333137396437616664373965
                36313539643138616331393939623436353736333937623430333636663864393866313035643463
                32613739633461666336643437333035656230623963316565616166316130653034396664363639
                31303963346635653836656539346465663435346563346333636530323338386130333530386661
                39643535613964633266356531633066383739656533646538633133386661653932366562376331
                64623134396661333833316136396330343730623565393437663632343535396534623064613532
                66313335636363376166396164363862373932633939663461636333386431356335393437393362
                65346630323832663036643363313530386536396131323235663461653434353736353637316337
                37393263383236643733396236653764633330303661626333343963393565636235393934663763
                61626631616435376566353265613434643363336639356635306532383662656437333231646135
                35663965636234363864396162383733373431396264356431326330376131306436633264313364
                62386464393665613164636134303962643065633562623138316364663335616532363063313263
                37626333363264343938313161326536383366633331646263306638643631386466646630633863
                36643638323466353436633564633064303138366165656662366131323431656639336535633963
                34363336633666363166633763363861303437383837376233313863346461666630323633343339
                34396331656537396134353966363065356430623932306534623865356363643035623430636436
                36636630653765316162663236393133633435386232613835316139643062613837353436613232
                32393532653432653639353430326463336633313734353463303336636331613263323033373938
                30393131303134366463646135353961336434646334343961303035346639343962383465303633
                31396266613738643736353036616231613863633465346231356565316635303331343031616636
                61383037393838383636643339613737373736393732616634393066363235376630303562376361
                31333838623431386263303264623633396331376361613861383932393164656166366163663439
                31663938333566363832633433616631643263646263383430383464623438396663383633646561
                35646531633832663438363135386532333266363132376363373134366138333134613666386238
                61663066643232653839363032303139316632383361376339303332653461353231316632396261
                65323933333837626333393663306431303332613261616438316639643234336261636338393866
                64356562313661663733323463356434636337666666306232373333326539363936633664313163
                32366431613631333234613032633636396532323963616634616262626235343330373863656631
                64663633613937643365373365636336636439316131613533316561633063356365616131663836
                61363932326235316238633436366632323437656439303437306165656636636534346133623966
                32376236663537353163303930326666356263376330316566353539366238646239633537393732
                66653336343935313564363462393537356138636562303838653166646265356431323065663234
                62356665383866303836336437363164333130323263386539366230386233306633306130633930
                30323836353161313538363262636233646231666438393464323235313536313666393935343830
                36376536373936366134656639373564616664613765653638326133656162376461343561353665
                33346531643064336534656264393438623138643565353166626361396436316637366639343861
                64313865636638343266373632653734343736386233656163616434613738623836313530386330
                39353765333165393564326264386230373539343934313439633735643934633232643666633235
                34386636313961366165336463376165333539326231313332346638303266356635376639323334
                61373265303233313937363733376337626434353061643339396238383363303030366134383331
                36656132393439613337616333623039346333636261656633666135376239303533373839383064
                30643830343364626264353762653830613030633166393135303165343366356336613565346637
                37373937323838653837623130373563613037356335363063636138336531636438366235386264
                39663838356264633862623638666236383265393230373561663761336637353331326537383133
                31313735653635656235393431613131336366653236336339653331323664663331643332313761
                34343965636534653065656466396136646633393936626161363764616135646233356237363766
                66353133333463653232396538383963366339376362343530356666353437353662373437636263
                39356266363736333931633237613735613030363962323032373561623230333634653833306566
                39313433666466616330663763386666386566366432313534313836613634643966363730636237
                626163663538386637636430616161373633
              client_email: "home-assistant@home-assistant-14ee3.iam.gserviceaccount.com"

    - name: Install HACS
      community.docker.docker_container_exec:
        container: "{{ application }}"
        command: bash -c "wget -O - https://get.hacs.xyz | bash -"
        chdir: /config
      notify: Restart
      register: _command_result
      changed_when: "'HACS directory already exist' not in _command_result.stdout"
