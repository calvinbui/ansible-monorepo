---

- hosts: homelab

  tasks:
    - name: Disable requiretty to enable Ansible pipelining
      ansible.builtin.lineinfile:
        dest: /etc/sudoers
        line: "{{ item.line }}"
        state: "{{ item.state }}"
      loop:
        - line: Defaults requiretty
          state: absent
        - line: Defaults !requiretty
          state: present
      vars:
        ansible_ssh_pipelining: false

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false
      when: ansible_distribution == "Ubuntu"

    - name: Install pip3 and setuptools
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      register: result
      until: result is success
      retries: 5
      delay: 5
      loop:
        - python3-pip
        - python3-setuptools

    - name: Set authorized keys
      ansible.posix.authorized_key:
        user: "{{ item }}"
        state: present
        key: https://github.com/calvinbui.keys
      loop:
        - root
        - "{{ common_user }}"

    - name: Disable motd files
      ansible.builtin.file:
        path: "{{ item }}"
        mode: "-x"
      loop:
        - /etc/update-motd.d/50-motd-news
        - /etc/update-motd.d/10-help-text

    - name: No password sudo
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: "^{{ common_user }}"
        line: "{{ common_user }} ALL=(ALL) NOPASSWD: ALL"
        validate: "visudo -cf %s"

    - name: Install apt packages
      apt:
        name:
          - neovim
          - htop
          - iftop
          - nano
          - tree
          - unzip
          - ncdu
          - curl
          - wget
          - dnsutils
          - git
          - zfsutils-linux
          - jq
          - ripgrep
          - sqlite3
        state: present

    - name: Install snap packages
      community.general.snap:
        name:
          - yq

    - name: Remove packages
      ansible.builtin.apt:
        name:
          - popularity-contest
          - pastebinit
          - ubuntu-advantage-tools
        state: present

    - name: Set timezone
      community.general.timezone:
        name: "{{ common_timezone }}"

    - name: Create common directory
      ansible.builtin.file:
        path: "{{ common_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"
