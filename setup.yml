---

- hosts: homelab

  handlers:
    - name: Update grub
      ansible.builtin.command: update-grub

  tasks:
    - name: Disable requiretty to enable Ansible pipelining
      ansible.builtin.lineinfile:
        dest: /etc/sudoers
        line: "{{ item.line }}"
        state: "{{ item.state }}"
      loop:
        - line: Defaults requiretty
          state: absent
        - line: Defaults !requiretty
          state: present
      vars:
        ansible_ssh_pipelining: false

    - name: Set hostname
      ansible.builtin.hostname:
        name: "homelab.{{ common_local_tld }}"

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false

    - name: Install pip3 and setuptools
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      register: result
      until: result is success
      retries: 5
      delay: 5
      loop:
        - python3-pip
        - python3-setuptools

    - name: Set authorized keys from GitHub
      ansible.posix.authorized_key:
        user: "{{ item }}"
        state: present
        key: https://github.com/calvinbui.keys
      loop:
        - root
        - "{{ common_user }}"

    - name: Generate root OpenSSH keypair
      community.crypto.openssh_keypair:
        path: /root/.ssh/id_ed25519
        type: ed25519
      register: _setup_root_ssh_key

    - name: Allow root self-SSH
      ansible.posix.authorized_key:
        user: "root"
        state: present
        key: "{{ _setup_root_ssh_key.public_key }}"

    - name: Generate user OpenSSH keypair
      community.crypto.openssh_keypair:
        path: "/home/{{ common_user }}/.ssh/id_ed25519"
        type: ed25519
      become: false
      become_user: "{{ common_user }}"
      register: _setup_user_ssh_key

    - name: Allow user self-SSH
      ansible.posix.authorized_key:
        user: "{{ common_user }}"
        state: present
        key: "{{ _setup_user_ssh_key.public_key }}"

    - name: Disable motd files
      ansible.builtin.file:
        path: "{{ item }}"
        mode: "-x"
      loop:
        - /etc/update-motd.d/50-motd-news
        - /etc/update-motd.d/10-help-text

    - name: No password sudo
      community.general.sudoers:
        name: "{{ common_user }}"
        user: "{{ common_user }}"
        commands: ALL
        nopassword: true

    - name: Install apt packages
      ansible.builtin.apt:
        name:
          - build-essential
          - neovim
          - htop
          - iftop
          - nano
          - tree
          - unzip
          - ncdu
          - curl
          - wget
          - dnsutils
          - git
          - zfsutils-linux
          - jq
          - ripgrep
          - update-notifier-common
          - unattended-upgrades
          - apache2-utils  # htpasswd
          - sqlite3
          # https://cisofy.com/lynis/controls/AUTH-9262/
          - libpam-passwdqc
          # https://cisofy.com/lynis/controls/PKGS-7370/
          - debsums
          # https://cisofy.com/lynis/controls/PKGS-7394/
          - apt-show-versions
          - iotop
          - powertop
          - mc
          - nethogs
        state: present

    - name: Install snap packages
      community.general.snap:
        name:
          - yq
        state: present

    - name: Remove packages
      ansible.builtin.apt:
        name:
          - popularity-contest
          - pastebinit
        state: absent

    - name: Set timezone
      community.general.timezone:
        name: "{{ common_timezone }}"

    - name: Create common directory
      ansible.builtin.file:
        path: "{{ common_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Set root email
      ansible.builtin.copy:
        dest: "/root/.forward"
        content: "homelab{{ common_email_to }}"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0644"

    - name: Configure unattended-upgrades
      ansible.builtin.lineinfile:
        dest: /etc/apt/apt.conf.d/50unattended-upgrades
        state: present
        regex: "^{{ item.key }}"
        line: "{{ item.key }} {{ item.value }};"
        validate: "echo %s && unattended-upgrades --dry-run"
      loop: "{{ items | dict2items }}"
      vars:
        items:
          "Unattended-Upgrade::MinimalSteps": "true"
          # "Unattended-Upgrade::Mail": ""
          # "Unattended-Upgrade::MailReport": "always"
          "Unattended-Upgrade::Remove-Unused-Kernel-Packages": "true"
          "Unattended-Upgrade::Remove-New-Unused-Dependencies": "true"
          "Unattended-Upgrade::Remove-Unused-Dependencies": "true"

    - name: Set GRUB timeout
      ansible.builtin.lineinfile:
        dest: /etc/default/grub
        state: present
        regex: "^GRUB_RECORDFAIL_TIMEOUT="
        line: "GRUB_RECORDFAIL_TIMEOUT=10"
      notify: Update grub

    - name: Update sysctls
      ansible.posix.sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
      loop:
        - name: fs.inotify.max_user_instances
          value: 256
