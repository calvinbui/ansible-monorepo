---

- hosts: homelab

  vars:
    application: bing-rewards

    bing_rewards_username: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      39343532653764666563323437373631353636666266343532343061656230336638383165393537
      3738386164386161643238653162303135346463326331310a363261656335356233653235613563
      37366361323431333966373238343534626439643839386337636663373737643439363638333663
      6536363862303531340a386163343639613730353935396339393030626561366264313835396561
      33633837336531376138323561386533333332363339393832613563653838383161

    bing_rewards_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      32376564366666626336373036353436376165356462636137393232626235623239383964616361
      6530326165663365313664386332636562326163306535380a386264326433663030616364343766
      37353364336266353035623134346437313138666136313939373566353533383634663765386263
      6364633362366234340a366339626230353539363763316666373936343230316130343963393738
      32316461353834376239333835306439366235633537353231616439666535633562653538653364
      3631383735396631383564306332363431363166353139643833

    bing_rewards_google_sheets:
      id: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        32366563646232376565376437623263623364626636623931663936353439353934323765313835
        3336653132663432623637343038656331666462383631640a373066363935326433393034643533
        66633030383030623039636662343064363135323061353465386334333239353762366361303332
        6436383063663365310a613264623166393430303937306536646563326537323030393530653835
        64366163353031343034343533623938343730383063336338643732373934393337313264656661
        3935323764313239313031316564623863353265396234383363
      tab: Sheet1

    docker_network: "{{ networks.pub }}"

  handlers:
    - name: Restart
      community.docker.docker_container:
        name: "{{ application }}"
        restart: true
        comparisons:
          '*': ignore

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create google_sheets_credentials.json
      ansible.builtin.copy:
        dest: "{{ config_directory }}/google_sheets_credentials.json"
        mode: "755"
        content: "{{ _bing_rewards_google_credentials_json  }}"
      vars:
        _bing_rewards_google_credentials_json: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64373039333931616139386164316435313132393039343134396432316530356461386562333234
          6264333036386635323961366333353265653036303334640a333038373362356135363538363034
          36366134313735396637616536393430613634636466333832643730373233373530373736636632
          6134316638626230370a386261396364343062653033373866316431333532386163383962346163
          31366530636532363865303361346163623362633439313531613234646234396261656236623162
          64303964663766393039386665366662333832663635396532363162306132646536356264613435
          33303464346539663231653930666531613735343965363364313933313833636336333930356162
          35383437323233633663373633643931396530343331353632376437313761336334656466313731
          64653539666635303435613235653437316566616162663063353865366163633637316664326336
          32313234396334363232646165326538356231393734373362663232663762653333623765663364
          61386665646333643732613135366131643738633366613830353737346364636565613363353230
          31356437366237386133343536303233396537376533353964653235386339363461336234613038
          35613232376330313431393636333331313936376265373534653436666133383833633062626330
          63386263353437653930313864666233306230383835356332616166383261616364633232336462
          65343838383332626662623735646232306336393430386665303664366132623061366465653430
          31343233303730303035653638303033666539366564656636626463366130383561376631373437
          65653138323137393433373033383565653134613432616363323836326637353334336131306537
          37316333616665643337366366303130386561363639376635386130363638396634383633636637
          65323130616534376361623237636464363632323635616566393731333132393937333632393738
          31306364656136616462356634376635326634373633323830346231396564313938373034366538
          62643265613664323561656665306630663662303939333734623138323138306330613832346637
          64666461373165613332613734396163663231636466646538656236316239386261346164643130
          65303535656433633638373461326362353062343634326137313737633565363436626662396136
          36653431306639636330393039356466363237363435326361656131313438633636373431313934
          33636263383762646664666664336465323334653663386361623339616631623630
      notify: Restart

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        # https://bitbucket.org/bing-rewards/bing-rewards
        image: jwong235/bing-rewards:v2.2
        command:
          - bash
          - -c
          - |
            /usr/local/bin/python3 /bing-rewards/BingRewards/setup.py \
            --email "{{ bing_rewards_username }}" \
            --password "{{ bing_rewards_password }}" \
            --google_sheets_sheet_id "{{ bing_rewards_google_sheets.id }}" \
            --google_sheets_tab_name "{{ bing_rewards_google_sheets.tab }}";

            /bin/sed -i 's|-nsb$|-nsb -gs|' /bing-rewards/script.sh;
        env:
          TZ: "{{ common_timezone }}"
        volumes:
          - "{{ config_directory }}:/bing-rewards/BingRewards/config"
