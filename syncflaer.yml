---
- hosts: homelab
  become: true
  module_defaults:
    docker_container:
      keep_volumes: false
      state: started
      restart_policy: unless-stopped
      networks_cli_compatible: true
      purge_networks: true
      networks:
        - name: "{{ network.name }}"
      dns_servers: "{{ network.dns }}"
      comparisons:
        env: allow_more_present
        labels: allow_more_present
      container_default_behavior: no_defaults
      network_mode: "{{ network.name }}"
  vars:
    network: "{{ networks.mgmt }}"
    syncflaer_domain_ip_lookup: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      64346463303536643164343666613961613938666231626562666339313761363161313932653739
      3664346439353934353862373932316139313537396461660a336539616638306334663435653835
      61616636383239353463306637636638393333643262646133336532393464306531623034396266
      3838323433653766310a626433383939353461633030356365663438373733396265633436336330
      66346333666336353438386133636133613431623662326538343730663738386132
    
    syncflaer_slack_webhook: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      36323362393133353432326232656466636531366535633437313839643534336136323439323730
      3164626134633236313631626462663164373963396135630a343231666238303631643666383366
      64666136663032633035396636353636333363363934313763396334663230366232643339313830
      6163366235326639360a626237363938643030656266623330313864346130363235666261376562
      66613863623565343463356561323530656535396436663566656435613837373634366466323434
      66646131623838346162393936363733313966336330333764643639333763303063316432373738
      32363133643731626135363763313764303539633461343237383264333433363864363135356437
      63643866623438623463
  handlers:
    - name: Restart Python DNS
      shell: docker restart syncflaer-dns

    - name: Restart SyncFlaer
      shell: docker restart syncflaer
  tasks:
    - name: Create SyncFlaer folder
      file:
        path: "{{ common_directory }}/syncflaer"
        state: directory
        owner: "1000"
        group: "1000"

    - name: Copy Python DNS script
      copy:
        src: files/syncflaer/main.py
        dest: "{{ common_directory }}/syncflaer/main.py"
      notify: Restart Python DNS

    - name: Create Python DNS Container
      docker_container:
        name: syncflaer-dns
        hostname: syncflaer-dns
        image: gcr.io/distroless/python3
        command:
          - /app/main.py
        volumes:
          - "{{ common_directory }}/syncflaer:/app"
        labels:
          traefik.enable: "false"
        env:
          HOSTNAME: "{{ syncflaer_domain_ip_lookup }}"

    - name: Template SyncFlaer config
      template:
        src: templates/syncflaer/config.yml.j2
        dest: "{{ common_directory }}/syncflaer/config.yml"
      notify: Restart SyncFlaer

    - name: Create SyncFlaer Container
      docker_container:
        name: syncflaer
        hostname: syncflaer
        image: containeroo/syncflaer
        volumes:
          - "{{ common_directory }}/syncflaer/config.yml:/config.yml"
        labels:
          traefik.enable: "false"
        restart_policy: "no"
    
    - name: Run SyncFlaer container periodically
      cron:
        name: "SyncFlaer"
        minute: "*"
        job: "docker start syncflaer"