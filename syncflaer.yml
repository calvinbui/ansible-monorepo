---

- hosts: homelab

  vars:
    application: syncflaer

    syncflaer_domain_ip_lookup: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      64346463303536643164343666613961613938666231626562666339313761363161313932653739
      3664346439353934353862373932316139313537396461660a336539616638306334663435653835
      61616636383239353463306637636638393333643262646133336532393464306531623034396266
      3838323433653766310a626433383939353461633030356365663438373733396265633436336330
      66346333666336353438386133636133613431623662326538343730663738386132

    syncflaer_slack_webhook: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      36323362393133353432326232656466636531366535633437313839643534336136323439323730
      3164626134633236313631626462663164373963396135630a343231666238303631643666383366
      64666136663032633035396636353636333363363934313763396334663230366232643339313830
      6163366235326639360a626237363938643030656266623330313864346130363235666261376562
      66613863623565343463356561323530656535396436663566656435613837373634366466323434
      66646131623838346162393936363733313966336330333764643639333763303063316432373738
      32363133643731626135363763313764303539633461343237383264333433363864363135356437
      63643866623438623463

    docker_network: "{{ networks.mgmt }}"

  handlers:
    - name: Restart Python DNS
      ansible.builtin.command: "docker restart {{ application }}-dns"

    - name: Restart SyncFlaer
      ansible.builtin.command: "docker restart {{ application }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"
      register: _config_dir

    - name: Copy Python DNS script
      ansible.builtin.copy:
        src: '{{ files_directory }}/main.py'
        dest: "{{ _config_dir.path }}/main.py"
        owner: "{{ common_user_id }}"
        group: "{{ common_root_group }}"
        mode: "0770"
      notify: Restart Python DNS

    - name: Create Python DNS Container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-dns"
        image: gcr.io/distroless/python3
        command:
          - /app/main.py
        volumes:
          - "{{ _config_dir.path }}:/app"
        env:
          HOSTNAME: "{{ syncflaer_domain_ip_lookup }}"

    - name: Template config
      ansible.builtin.template:
        src: "{{ files_directory }}/config.yml.j2"
        dest: "{{ _config_dir.path }}/config.yml"
        owner: "{{ common_user_id }}"
        group: "{{ common_root_group }}"
        mode: "0770"
      notify: Restart SyncFlaer

    - name: Create SyncFlaer container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: containeroo/syncflaer:4.0.0
        volumes:
          - "{{ _config_dir.path }}/config.yml:/config.yml"
        restart_policy: "no"
        state: present

    - name: Run SyncFlaer container periodically
      ansible.builtin.cron:
        name: "SyncFlaer"
        minute: "*"
        job: "docker start syncflaer"
