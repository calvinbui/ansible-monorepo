---

- hosts: homelab

  vars:
    application: lazydocker

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"
      register: _config_dir

    - name: Install github3.py
      ansible.builtin.pip:
        name: github3.py
        executable: pip3

    - name: Get latest release
      community.general.github_release:
        user: jesseduffield
        repo: lazydocker
        action: latest_release
      register: _lazydocker_latest_version

    - name: "Get all checksums"
      ansible.builtin.set_fact:
        _lazydocker_checksums: "{{ lookup('url', 'https://github.com/jesseduffield/lazydocker/releases/download/' + _lazydocker_latest_version.tag + '/checksums.txt', wantlist=True) | list }}"
      run_once: true

    - name: "Filter checksum for {{ansible_system }} {{ ansible_architecture }}"
      ansible.builtin.set_fact:
        _lazydocker_checksum: "{{ item.split(' ')[0] }}"
      loop: "{{ _lazydocker_checksums }}"
      when:
        - "(ansible_system + '_' + ansible_architecture + '.tar.gz') in item"

    - name: Download
      ansible.builtin.get_url:
        url: "https://github.com/jesseduffield/lazydocker/releases/download/{{ _lazydocker_latest_version.tag }}/lazydocker_{{ _lazydocker_latest_version.tag.split('v')[1] }}_{{ ansible_system }}_{{ ansible_architecture }}.tar.gz"
        dest: "{{ _config_dir.path }}/"
        checksum: "sha256:{{ _lazydocker_checksum }}"
      register: _lazydocker_download

    - name: Unarchive
      ansible.builtin.unarchive:
        src: "{{ _lazydocker_download.dest }}"
        dest: "{{ _config_dir.path }}"
        mode: "0755"
        remote_src: true

    - name: Symlink to PATH
      ansible.builtin.file:
        src: "{{ _config_dir.path }}/lazydocker"
        dest: /usr/local/bin/lazydocker
        state: link
