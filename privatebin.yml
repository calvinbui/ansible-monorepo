---

- hosts: homeserver

  vars:
    application: privatebin

    container_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folders
      ansible.builtin.file:
        path: "{{ config_directory }}/{{ item }}"
        state: directory
        mode: "0700"
        owner: nobody
        group: "82"  # nobody in alpine
      loop:
        - cfg
        - data

    - name: Template config
      ansible.builtin.template:
        src: "{{ files_directory }}/conf.php.j2"
        dest: "{{ config_directory }}/cfg/conf.php"
        mode: "0644"
        owner: nobody
        group: "82"  # nobody in alpine

    - name: Create container
      ansible.builtin.include_role:
        name: podman_container
      vars:
        image: ghcr.io/privatebin/nginx-fpm-alpine:2.0.1
        volumes:
          - "{{ config_directory }}/data:/srv/data"
          - "{{ config_directory }}/cfg:/srv/cfg"
        traefik:
          - port: 8080
        homepage:
          name: PrivateBin
          group: Sharing
          weight: 790
          description: "Zero knowledge pastebin"
