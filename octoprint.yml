---

- hosts: homelab

  vars:
    application: octoprint

    docker_network: "{{ networks.iot }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0755"
      register: _config_dir

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: octoprint/octoprint
        volumes:
          - "{{ config_directory }}:/octoprint"
        devices:
          - /dev/ttyACM0
          - /dev/video0
        env:
          ENABLE_MJPG_STREAMER: "true"
          MJPG_STREAMER_INPUT: "-n -r 1280x720"
        traefik:
          - port: 80
            auth: page
        labels:
          com.centurylinklabs.watchtower.lifecycle.pre-update: /octoprint/idle.sh

    - name: Wait for config file
      ansible.builtin.wait_for:
        path: "{{ _config_dir.path }}/octoprint/config.yaml"

    - name: Update config
      yedit:
        src: "{{ _config_dir.path }}/octoprint/config.yaml"
        key: "{{ item.key }}"
        value: "{{ item.value }}"
      loop:
        - key: server.commands.serverRestartCommand
          value: s6-svc -r /var/run/s6/services/octoprint
        - key: accessControl.remoteUserHeader
          value: Remote-User
        - key: accessControl.trustRemoteUser
          value: true

    - name: Get API key
      yedit:
        src: "{{ _config_dir.path }}/octoprint/config.yaml"
        key: api.key
        state: list
      register: _octoprint_api_key

    - name: Template idle check
      ansible.builtin.template:
        src: "{{ files_directory }}/idle.sh.j2"
        dest: "{{ _config_dir.path }}/idle.sh"
        owner: "{{ common_root_id }}"
        group: "{{ common_root_group }}"
        mode: "0755"
