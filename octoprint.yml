---

- hosts: homelab

  vars:
    application: octoprint

    docker_network: "{{ networks.iot }}"

  tasks:
    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: octoprint/octoprint
        volumes:
          - "{{ config_directory }}:/octoprint"
        devices:
          - /dev/ttyACM0
          - /dev/video0
        env:
          ENABLE_MJPG_STREAMER: "true"
          MJPG_STREAMER_INPUT: "-n -r 1920x1080"
        traefik:
          - port: 80
        labels:
          # auth on the webcam
          traefik.http.routers.octoprint-webcam.entrypoints: web-secure
          traefik.http.routers.octoprint-webcam.tls: "true"
          traefik.http.routers.octoprint-webcam.service: "{{ application }}"
          traefik.http.routers.octoprint-webcam.rule: Host(`{{ application }}.{{ common_tld }}`) && PathPrefix(`/webcam`)
          traefik.http.routers.octoprint-webcam.middlewares: "{{ traefik_middleware_authelia }}"

          # in case it's printing
          com.centurylinklabs.watchtower.enable: "false"
