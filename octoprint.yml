---

- hosts: octopi

  vars:
    common_user: pi

  tasks:
    - name: Disable requiretty to enable Ansible pipelining
      ansible.builtin.lineinfile:
        dest: /etc/sudoers
        line: "{{ item.line }}"
        state: "{{ item.state }}"
      loop:
        - line: Defaults requiretty
          state: absent
        - line: Defaults !requiretty
          state: present
      vars:
        ansible_ssh_pipelining: false

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false
      when: ansible_distribution == 'Ubuntu'

    - name: Set authorized keys
      ansible.posix.authorized_key:
        user: "{{ item }}"
        state: present
        key: https://github.com/calvinbui.keys
      loop:
        - root
        - "{{ common_user }}"

    - name: No password sudo
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: "^{{ common_user }}"
        line: "{{ common_user }} ALL=(ALL) NOPASSWD: ALL"
        validate: 'visudo -cf %s'

    - name: Install apt packages
      apt:
        name:
          - neovim
          - htop
          - iftop
          - nano
          - tree
          - unzip
          - ncdu
          - curl
          - wget
          - dnsutils
          - git
        state: present

    - name: Remove packages
      ansible.builtin.apt:
        name:
          - popularity-contest
          - pastebinit
        state: present

    - name: Set timezone
      community.general.timezone:
        name: "{{ common_timezone }}"
