---

- hosts: homelab

  vars:
    application: gluetun

    docker_network: "{{ networks.pub }}"

  tasks:
    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-{{ item.city }}"
        image: ghcr.io/qdm12/gluetun:v3.39.0
        ipv4_address: "{{ docker_network.prefix }}.{{ item.ip }}"
        capabilities:
          - NET_ADMIN
        volumes:
          - "{{ config_directory }}:/gluetun"
        env:
          VPN_SERVICE_PROVIDER: custom
          VPN_TYPE: wireguard

          VPN_ENDPOINT_IP: "{{ lookup('community.general.dig', item.server + '.') }}"
          VPN_ENDPOINT_PORT: "51820"
          WIREGUARD_PUBLIC_KEY: "{{ item.public_key }}"
          WIREGUARD_PRIVATE_KEY: "{{ item.private_key }}"
          WIREGUARD_ADDRESSES: "{{ item.address }}/32"

          HTTPPROXY: "on"
          HTTPPROXY_STEALTH: "on"

          DOT: "off"
          BLOCK_MALICIOUS: "off"
          BLOCK_SURVEILLANCE: "off"
          BLOCK_ADS: "off"

          TZ: "{{ common_timezone }}"
      loop:
        -
          city: sydney
          ip: 246
          server: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            32323839626632643539323934306465343563313861393230623334633561656430366631636661
            6230373061613439623039356535376465346532303630660a626433313033393963613139356639
            33633561386564393938393062623233346164383736343262313731303432333962643062393930
            6130613166336631300a323731653034383634396562613030633866393334623538393537393436
            65323830366264316136633536326634343864653162653632653635643930306235
          public_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            36613533666365343832613432363331396534623137363839323366616161346164343064656565
            3162383233653838633130613062383965353464663633390a633466373632343539353438633939
            30326361303363333262653861643431663964636562613831343431623435656666383161623834
            6538643732356162300a396136343061316465343436613339626431656139376438393332646564
            63386661353830633830643531663831616339373235316533306434386537646264323530356265
            3366313063656265653933663365356661646536646335343831
          private_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            34666563656563306666623361323331326336646230323663336664343637316638663133353661
            3334323164373066343339323737313439663136356138330a633534663763313164623036646430
            66353066353162376136373430303433623939393864383361656661363061343264663561613262
            3933636165643236650a303835356632353562346361656639353231626334326630323964326430
            31623639383462656330333439353966636239646234303864623365623737303363646532356663
            3436353133313438363738353739313339343532663361386335
          address: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            66643733306639656137376463303266323566613931303132323063366233383739316561386364
            3837376265386432343430653435383730303666616535300a626537336537366461646338663738
            37336631326163363866383032666330646362326236313736386435303632326165353363396637
            3835333537633062390a336264376162313737333565313935623462636366343534336434623736
            3936
        -
          city: melbourne
          ip: 245
          server: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            33396238336130383463316433616335666361303366623639393766383966633935356132643565
            6432623933643232313464326464653238383734363139660a626335373633623634336137353332
            37376236346535633366653031383530336362303237316661373764323639656661326338353036
            6563383261626463390a316564353435366237386165643734343935303438643737343439653330
            31633238333430616561343733353534623638383064663238656439303237353736
          public_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            30656265316133323065663562386239633565643931383434633761623762636662643564633564
            3830346361376133623365313362376233623730643234620a396339383365643734356262623565
            31326464396135653334373232373335313235323163333532356163663936353263663762613832
            3861656265623438660a626136313662316631323337626636356237366130646463633239356561
            66386339333135343139373764643831303766363264653533353938393737636633653936326636
            3734373637643531396266373765373739666536313337383664
          private_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62633336633732346634393839663137633031343930376432663431386434303863383165336164
            6134363663633864623566383563343831306532383662650a386135643632623165616634323138
            61383862376165373335393438666162383236316539303266366261373139376363653437336339
            6139333237396566380a303364646532383335613933643461313464363633383662613235303430
            64353863613030373238633932643365656138666132303930646334313336656437313538653139
            6632393131333036666138343466663064633062613565623866
          address: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            33666162333462616531636639396532363435343462333436323230373838636339663765383465
            6138333861373937393265653463373764623830393732330a636430313863356234613737633033
            64646339663531303937303966656332346439613933313639653966363661656338373330303230
            3435626537643234370a613365366236356166616532656464396335366438346330316663663363
            3563
        -
          city: brisbane
          ip: 244
          server: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            38393138353939336666383931316334346636626339373934356661643664646435373431386162
            6239343837336165623537616433363630643536636662630a306533383463323931343431643334
            37383763343731613030633631646137616134653666646534363339623434333035316631643562
            6534336333363262360a613466373539393239386635306466303436313363383930373935336637
            37333839313866303361306233333736303838346136333165653035396364633563
          public_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            66653563323036303066386531393030613332396531613166623161626334643632633961353639
            3165386161356362386663363039323164323334386638650a396538636531363839666661363062
            61336130353432613739373532623766626430353134386663623735663966323238393665643535
            6362653735376264380a363564643864613139626230343732643433356364313434623138343635
            36616630633865373336636163316633356165303166646165303834656163303930653535343336
            3930623538396164323537383733376633393134363638313065
          private_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            31326432353237333763383235666635373932396335396565323737663133396161303833303262
            6662373162313264636363336430356631343564363966370a303761326165623437616637636563
            66633363363964633939356562616235373435323639653430366439396436386563346332383430
            3931373266326233360a313234346336373362343364656339656261653932316336613336626638
            66653064363562306332373562303134303961326562633166393263656238343830663637633535
            3232346561323063656162623561653938626632363965633431
          address: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            62633663313661613031396237343166313833613733303437373537393362323237323833663162
            3838393766333966633939356230396132323866653337360a366166616335656631303861373265
            33393033623537663437646130313263363437346231386631383933393865633637313330373839
            6138623036396232380a326461663635386334663134343131653339313834626166656534326130
            6638
        -
          city: perth
          ip: 243
          server: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            63613239346636666563393837393461373864353132326433396132373164653038303230353062
            3437653761313332366231666264316139353466336266320a396334633139326632373931663366
            63336565373031333161333931646166313630386664336537343636333766636437633765396564
            3630366332366361360a663161336236333566343665396663663036316139653364383266333264
            65373737643939306536343563633230626635316436313163336162623832383464
          public_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            65616165363161353337316330333264363861613961313434663630623432643932306133303561
            3036343738643363636432626230306136303964643032350a383333666136663230333562343733
            61363031363262323363656139356339646563326434636666323134623036353339336661613061
            3735376264656163370a356561303832323666323439313366373465653531336530386463633130
            63373165396134323931346331633565646637363965383063303134353163316164393231376639
            3363663164616436363365366333336238386335383661353935
          private_key: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            61666434653231363231333838396230666331633631626362653131306137623164353930663833
            6266393562386539313132646139633735656233663632340a376566313338613936326137653132
            36383733313338616666386666356436363638623662666361653361346636636230623163626661
            3861353733373232360a373836333936353233656434346263313566376338393337333961303834
            35303137396538653536666462643233343563646239653764383862653461346461336161383533
            3035336338383763666362343663306438616263376366613030
          address: !vault |
            $ANSIBLE_VAULT;1.1;AES256
            37326365373033383737363730396163656166393861646162326363313231616365613331363830
            3432363464336664356165343131366432326534393533390a376538316365393437393535636436
            64626436353934333565666266326134393864353831336234653864633138333239613934643163
            3662616435623663630a396166356335666638636234316262353161316166653631336162363661
            3535
