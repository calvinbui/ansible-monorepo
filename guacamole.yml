---

- hosts: homelab

  vars:
    application: guacamole

    postgres_password: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      30336234666131353835373535303330653030343362616236613238323738333139393264376537
      6432333034306266303937623965396261633734323437300a356662623666346363623565363431
      38613263636132383361323763363939363531356566636138323463376239323238343863373930
      3430326538393062370a353631663063333532396530326264333763383233373664383538666665
      30323233326666313636313831393065623339356633613535313961333131323033653933336639
      3031393834336639313964353266363665366634646235346539

    guacd_name: guacamole-guacd

    docker_network: "{{ networks.user }}"

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 600
      changed_when: false
      when: ansible_distribution == 'Ubuntu'

    - name: Create config folder
      ansible.builtin.file:
        path: "{{ config_directory }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Create app folder
      ansible.builtin.file:
        path: "{{ config_directory }}/{{ application }}"
        state: directory
        owner: "{{ common_user }}"
        group: "{{ common_group }}"
        mode: "0771"

    - name: Copy SQL database init script
      ansible.builtin.copy:
        src: "files/{{ application }}/initdb.sql"
        dest: "{{ config_directory }}/{{ application }}"
        mode: "0444"

    - name: Create postgres container
      ansible.builtin.include_role:
        name: postgres
      vars:
        postgres_name: "{{ application }}-postgres"
        postgres_version: '12'
        postgres_directory: "{{ config_directory }}/postgres"
        postgres_directory_extra:
          - "{{ config_directory }}/{{ application }}/initdb.sql:/docker-entrypoint-initdb.d/initdb.sql:ro"
        postgres_environment_variables:
          POSTGRES_USER: "{{ application }}"
          POSTGRES_PASSWORD: "{{ postgres_password }}"
          POSTGRES_DB: "{{ application }}"

    - name: Create guacd container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        name: "{{ application }}-guacd"
        image: guacamole/guacd
        env:
          GUACD_LOG_LEVEL: debug

    - name: Create guacamole container
      ansible.builtin.include_role:
        name: docker_container
      vars:
        image: guacamole/guacamole
        volumes:
          - "{{ config_directory }}/{{ application }}:/config"
        env:
          GUACD_HOSTNAME: "{{ application }}-guacd.{{ docker_network.name }}"
          GUACD_LOG_LEVEL: debug
          POSTGRES_HOSTNAME: "{{ application }}-postgres.{{ docker_network.name }}"
          POSTGRES_DATABASE: "{{ application }}"
          POSTGRES_USER: "{{ application }}"
          POSTGRES_PASSWORD: "{{ postgres_password }}"
        traefik:
          - port: 8080
        labels:
          traefik.http.routers.guacamole-secure.middlewares: "guacamole-addprefix"
          traefik.http.middlewares.guacamole-addprefix.addprefix.prefix: "/guacamole"
